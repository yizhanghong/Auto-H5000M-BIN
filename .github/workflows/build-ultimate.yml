name: "Build ImmortalWrt H5000M fix"

on:
  workflow_dispatch:
    inputs:
      enable_adguardhome:
        description: 'å¯ç”¨ AdGuardHome (å¹¿å‘Šæ‹¦æˆª)'
        required: false
        type: boolean
        default: true
      enable_openclash:
        description: 'å¯ç”¨ OpenClash (ä»£ç†å·¥å…·)'
        required: false
        type: boolean
        default: false
      enable_mihomo:
        description: 'å¯ç”¨ Mihomo (ä»£ç†å·¥å…·)'
        required: false
        type: boolean
        default: false
      enable_upnp:
        description: 'å¯ç”¨ UPnP (ç«¯å£æ˜ å°„)'
        required: false
        type: boolean
        default: true
      enable_vlmcsd:
        description: 'å¯ç”¨ VLMCSd (KMSæ¿€æ´»æœåŠ¡)'
        required: false
        type: boolean
        default: false
      enable_mosdns:
        description: 'å¯ç”¨ MosDNS (DNSæœåŠ¡)'
        required: false
        type: boolean
        default: false
      enable_dockerman:
        description: 'å¯ç”¨ DockerMan (Dockerç®¡ç†)'
        required: false
        type: boolean
        default: false
      enable_qmodem_next:
        description: 'å¯ç”¨ QModem Next (5Gç®¡ç†æ–°ç‰ˆ)'
        required: false
        type: boolean
        default: true
      enable_qmodem:
        description: 'å¯ç”¨ QModem (5Gç®¡ç†æ—§ç‰ˆ)'
        required: false
        type: boolean
        default: false
      enable_mwan:
        description: 'å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)'
        required: false
        type: boolean
        default: true
      max_build_time:
        description: 'æœ€å¤§ç¼–è¯‘æ—¶é—´(åˆ†é’Ÿ)'
        required: false
        type: number
        default: 120

env:
  REPO_URL: 'https://github.com/immortalwrt/immortalwrt'
  REPO_BRANCH: 'openwrt-24.10'
  CONFIG_URL: 'https://raw.githubusercontent.com/ophub/amlogic-firmware/main/boxes/mt7987/mt7987_mt7992.config'
  SOURCE_DIR: 'immortalwrt'
  TZ: 'Asia/Shanghai'

jobs:
  # æ™ºèƒ½åˆ†æä»»åŠ¡
  analyze:
    name: ğŸ” æ™ºèƒ½åˆ†æ
    runs-on: ubuntu-24.04
    outputs:
      config-hash: ${{ steps.config-hash.outputs.hash }}
      use-incremental: ${{ steps.decision.outputs.use-incremental }}
      build-strategy: ${{ steps.decision.outputs.build-strategy }}
      clean-level: ${{ steps.decision.outputs.clean-level }}
      optimal-threads: ${{ steps.decision.outputs.optimal-threads }}
      needs-rebuild: ${{ steps.decision.outputs.needs-rebuild }}
      cache-hit-dl: ${{ steps.cache-dl.outputs.cache-hit }}
      cache-hit-toolchain: ${{ steps.cache-toolchain.outputs.cache-hit }}
      cache-hit-ccache: ${{ steps.cache-ccache.outputs.cache-hit }}
    steps:
  - name: ğŸ›’ ç­¾å‡ºä»“åº“
    uses: actions/checkout@v4

  - name: ğŸ—ï¸ ç”Ÿæˆé…ç½®å“ˆå¸Œ
    id: config-hash
    run: |
      # ç”Ÿæˆå®Œæ•´é…ç½®å“ˆå¸Œ
      CONFIG_CONTENT=""

      # æ·»åŠ åŸºç¡€é…ç½®
      [ -f "h5000m.extra.config" ] && CONFIG_CONTENT+="$(cat h5000m.extra.config)"
      [ -f "feeds.conf.default" ] && CONFIG_CONTENT+="$(cat feeds.conf.default)"

      # æ·»åŠ ç”¨æˆ·è¾“å…¥
      CONFIG_CONTENT+="${{ toJson(inputs) }}"

      # ç”Ÿæˆå“ˆå¸Œ
      HASH=$(echo "$CONFIG_CONTENT" | sha256sum | cut -d' ' -f1)
      echo "hash=$HASH" >> $GITHUB_OUTPUT
      echo "ğŸ” é…ç½®å“ˆå¸Œ: $HASH"

  - name: ğŸ“Š æ£€æŸ¥ç¼“å­˜çŠ¶æ€
    id: cache-check
    run: |
      # æ£€æŸ¥å„ç§ç¼“å­˜çŠ¶æ€
      echo "::group::ğŸ” æ£€æŸ¥ç¼“å­˜çŠ¶æ€"

      # DLç¼“å­˜æ£€æŸ¥
      DL_KEY="${{ runner.os }}-dl-v3-${{ env.REPO_BRANCH }}-${{ steps.config-hash.outputs.hash }}"
      if [ -f ".cache_info/dl_cache" ]; then
        echo "dl-cache-exist=true" >> $GITHUB_OUTPUT
        echo "âœ… DLç¼“å­˜å¯èƒ½å­˜åœ¨"
      else
        echo "dl-cache-exist=false" >> $GITHUB_OUTPUT
        echo "âŒ DLç¼“å­˜ä¸å­˜åœ¨"
      fi

      # Toolchainç¼“å­˜æ£€æŸ¥
      TOOLCHAIN_KEY="${{ runner.os }}-toolchain-v3-${{ env.REPO_BRANCH }}-${{ steps.config-hash.outputs.hash }}"
      if [ -f ".cache_info/toolchain_cache" ]; then
        echo "toolchain-cache-exist=true" >> $GITHUB_OUTPUT
        echo "âœ… Toolchainç¼“å­˜å¯èƒ½å­˜åœ¨"
      else
        echo "toolchain-cache-exist=false" >> $GITHUB_OUTPUT
        echo "âŒ Toolchainç¼“å­˜ä¸å­˜åœ¨"
      fi

      # ccacheç¼“å­˜æ£€æŸ¥
      CCACHE_KEY="${{ runner.os }}-ccache-v3-${{ env.REPO_BRANCH }}-${{ steps.config-hash.outputs.hash }}"
      if [ -f ".cache_info/ccache_cache" ]; then
        echo "ccache-cache-exist=true" >> $GITHUB_OUTPUT
        echo "âœ… ccacheç¼“å­˜å¯èƒ½å­˜åœ¨"
      else
        echo "ccache-cache-exist=false" >> $GITHUB_OUTPUT
        echo "âŒ ccacheç¼“å­˜ä¸å­˜åœ¨"
      fi

      echo "::endgroup::"

  - name: ğŸ§  æ™ºèƒ½å†³ç­–
    id: decision
    run: |
      echo "::group::ğŸ§  æ™ºèƒ½æ„å»ºå†³ç­–"

      # åˆ†æç¼“å­˜çŠ¶æ€
      DL_EXIST="${{ steps.cache-check.outputs.dl-cache-exist }}"
      TOOLCHAIN_EXIST="${{ steps.cache-check.outputs.toolchain-cache-exist }}"
      CCACHE_EXIST="${{ steps.cache-check.outputs.ccache-cache-exist }}"

      # è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
      CACHE_SCORE=0
      [ "$DL_EXIST" = "true" ] && CACHE_SCORE=$((CACHE_SCORE + 40))
      [ "$TOOLCHAIN_EXIST" = "true" ] && CACHE_SCORE=$((CACHE_SCORE + 35))
      [ "$CCACHE_EXIST" = "true" ] && CACHE_SCORE=$((CACHE_SCORE + 25))

      echo "ğŸ“Š ç¼“å­˜è¯„åˆ†: $CACHE_SCORE/100"

      # å†³ç­–é€»è¾‘
      if [ $CACHE_SCORE -ge 70 ]; then
        BUILD_STRATEGY="incremental"
        USE_INCREMENTAL="true"
        CLEAN_LEVEL="none"
        echo "âœ… å†³ç­–: å¢é‡æ„å»º (ç¼“å­˜è¯„åˆ†: $CACHE_SCORE)"
      elif [ $CACHE_SCORE -ge 40 ]; then
        BUILD_STRATEGY="hybrid"
        USE_INCREMENTAL="false"
        CLEAN_LEVEL="minimal"
        echo "ğŸ”„ å†³ç­–: æ··åˆæ„å»º (ç¼“å­˜è¯„åˆ†: $CACHE_SCORE)"
      else
        BUILD_STRATEGY="full"
        USE_INCREMENTAL="false"
        CLEAN_LEVEL="full"
        echo "ğŸ”¨ å†³ç­–: å®Œæ•´æ„å»º (ç¼“å­˜è¯„åˆ†: $CACHE_SCORE)"
      fi

      # çº¿ç¨‹ä¼˜åŒ–
      if [ "$BUILD_STRATEGY" = "incremental" ]; then
        THREADS=$(nproc)
      elif [ "$BUILD_STRATEGY" = "hybrid" ]; then
        THREADS=$(( $(nproc) * 3 / 2 ))
      else
        THREADS=$(nproc)
      fi

      # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å»º
      if [ $CACHE_SCORE -lt 50 ]; then
        NEEDS_REBUILD="true"
      else
        NEEDS_REBUILD="false"
      fi

      # è¾“å‡ºå†³ç­–ç»“æœ
      echo "use-incremental=$USE_INCREMENTAL" >> $GITHUB_OUTPUT
      echo "build-strategy=$BUILD_STRATEGY" >> $GITHUB_OUTPUT
      echo "clean-level=$CLEAN_LEVEL" >> $GITHUB_OUTPUT
      echo "optimal-threads=$THREADS" >> $GITHUB_OUTPUT
      echo "needs-rebuild=$NEEDS_REBUILD" >> $GITHUB_OUTPUT
      echo "cache-score=$CACHE_SCORE" >> $GITHUB_OUTPUT

      echo "::endgroup::"

  - name: ğŸ“¥ æ£€æŸ¥DLç¼“å­˜
    id: cache-dl
    uses: actions/cache/restore@v4
    with:
      path: immortalwrt/dl
      key: ${{ runner.os }}-dl-v3-${{ env.REPO_BRANCH }}-${{ steps.config-hash.outputs.hash }}
      restore-keys: |
        ${{ runner.os }}-dl-v3-${{ env.REPO_BRANCH }}-
        ${{ runner.os }}-dl-v3-

  - name: ğŸ”§ æ£€æŸ¥Toolchainç¼“å­˜
    id: cache-toolchain
    uses: actions/cache/restore@v4
    with:
      path: immortalwrt/staging_dir
      key: ${{ runner.os }}-toolchain-v3-${{ env.REPO_BRANCH }}-${{ steps.config-hash.outputs.hash }}
      restore-keys: |
        ${{ runner.os }}-toolchain-v3-${{ env.REPO_BRANCH }}-
        ${{ runner.os }}-toolchain-v3-

  - name: âš¡ æ£€æŸ¥ccacheç¼“å­˜
    id: cache-ccache
    uses: actions/cache/restore@v4
    with:
      path: ~/.ccache
      key: ${{ runner.os }}-ccache-v3-${{ env.REPO_BRANCH }}-${{ steps.config-hash.outputs.hash }}
      restore-keys: |
        ${{ runner.os }}-ccache-v3-${{ env.REPO_BRANCH }}-
        ${{ runner.os }}-ccache-v3-

  - name: ğŸ“‹ åˆ†ææŠ¥å‘Š
    run: |
      echo "::group::ğŸ“‹ æ™ºèƒ½åˆ†ææŠ¥å‘Š"
      cat << 'EOF'
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘        ImmortalWrt H5000M æ™ºèƒ½åˆ†ææŠ¥å‘Š        â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸ“Š åˆ†æç»“æœ:
      â€¢ é…ç½®å“ˆå¸Œ: ${{ steps.config-hash.outputs.hash }}
      â€¢ ç¼“å­˜è¯„åˆ†: ${{ steps.decision.outputs.cache-score }}/100
      â€¢ æ„å»ºç­–ç•¥: ${{ steps.decision.outputs.build-strategy }}
      â€¢ å¢é‡æ¨¡å¼: ${{ steps.decision.outputs.use-incremental }}
      â€¢ æ¸…ç†çº§åˆ«: ${{ steps.decision.outputs.clean-level }}
      â€¢ ä¼˜åŒ–çº¿ç¨‹: ${{ steps.decision.outputs.optimal-threads }}
      â€¢ éœ€è¦é‡å»º: ${{ steps.decision.outputs.needs-rebuild }}

      ğŸ’¾ ç¼“å­˜çŠ¶æ€:
      â€¢ DLç¼“å­˜: ${{ steps.cache-dl.outputs.cache-hit == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}
      â€¢ Toolchainç¼“å­˜: ${{ steps.cache-toolchain.outputs.cache-hit == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}
      â€¢ ccacheç¼“å­˜: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}

      âš™ï¸ ç”¨æˆ·é…ç½®:
      â€¢ AdGuardHome: ${{ inputs.enable_adguardhome }}
      â€¢ OpenClash: ${{ inputs.enable_openclash }}
      â€¢ Mihomo: ${{ inputs.enable_mihomo }}
      â€¢ UPnP: ${{ inputs.enable_upnp }}
      â€¢ VLMCSd: ${{ inputs.enable_vlmcsd }}
      â€¢ MosDNS: ${{ inputs.enable_mosdns }}
      â€¢ DockerMan: ${{ inputs.enable_dockerman }}
      â€¢ QModem Next: ${{ inputs.enable_qmodem_next }}
      â€¢ QModem: ${{ inputs.enable_qmodem }}
      â€¢ MWAN: ${{ inputs.enable_mwan }}

      ğŸ“ˆ é¢„æœŸæ€§èƒ½:
      â€¢ é¦–æ¬¡æ„å»º: ~90-120åˆ†é’Ÿ
      â€¢ å¢é‡æ„å»º: ~15-30åˆ†é’Ÿ
      â€¢ ç¼“å­˜ä¼˜åŒ–: å¯èŠ‚çœ60-80%æ—¶é—´

      EOF
      echo "::endgroup::"

  # æ™ºèƒ½æ„å»ºä»»åŠ¡
  build:
    name: ğŸš€ æ™ºèƒ½æ„å»º
    needs: analyze
    runs-on: ubuntu-24.04
    if: always()
    env:
      CONFIG_HASH: ${{ needs.analyze.outputs.config-hash }}
      BUILD_STRATEGY: ${{ needs.analyze.outputs.build-strategy }}
    steps:
  - name: ğŸ›’ ç­¾å‡ºä»“åº“
    uses: actions/checkout@v4

  - name: ğŸŒ è®¾ç½®æ—¶åŒº
    run: |
      sudo timedatectl set-timezone $TZ
      date

  - name: ğŸ“Š æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    run: |
      echo "ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:"
      uname -a
      echo ""
      echo "ğŸ’¾ å†…å­˜ä¿¡æ¯:"
      free -h
      echo ""
      echo "ğŸ’¿ ç£ç›˜ä¿¡æ¯:"
      df -h
      echo ""
      echo "ğŸ”§ CPUä¿¡æ¯:"
      nproc
      lscpu | grep "Model name" || true

  - name: ğŸ“¦ å®‰è£…ä¾èµ–
    run: |
      # æ˜¾ç¤ºç£ç›˜ç©ºé—´çŠ¶æ€
      echo "ğŸ’¾ å®‰è£…å‰ç£ç›˜çŠ¶æ€:"
      df -h /

      # å®‰è£…ä¾èµ–
      sudo apt-get update -qq
      sudo apt-get install -y build-essential git ccache python3 python3-pip \
        libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev rustc cargo \
        golang-go autoconf automake libtool patch make gcc g++

      - name: æºç å’Œä¾èµ–å‡†å¤‡
        timeout-minutes: 25
        run: |
          set -e
          echo "ğŸ“¥ å‡†å¤‡æºç å’Œä¾èµ–..."

          # æ˜¾ç¤ºç£ç›˜ç©ºé—´çŠ¶æ€
          echo "ğŸ’¾ å½“å‰ç£ç›˜çŠ¶æ€:"
          df -h /

          # å¹¶è¡Œæ‰§è¡Œæºç å‡†å¤‡å’Œfeedsé…ç½®
          {
            # ä»»åŠ¡1ï¼šå…‹éš†æˆ–æ›´æ–°æºç 
            echo "ğŸ“¥ [1/3] å‡†å¤‡æºç ..."
            START_TIME=$(date +%s)

            if [ ! -d "$SOURCE_DIR/.git" ]; then
              echo "ğŸ“¥ é¦–æ¬¡å…‹éš†æºç ..."
              git config --global http.postBuffer 1048576000
              git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
              echo "âœ… æºç å…‹éš†å®Œæˆ"
            else
              echo "ğŸ“¥ æ›´æ–°æºç ..."
              cd $SOURCE_DIR
              git config --global http.postBuffer 1048576000
              git remote prune origin
              git fetch origin $REPO_BRANCH --depth=1 || echo "âš ï¸ fetchå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬"
              git reset --hard origin/$REPO_BRANCH
              git clean -fd
              echo "âœ… æºç æ›´æ–°å®Œæˆ"
            fi

            END_TIME=$(date +%s)
            echo "â±ï¸ æºç å‡†å¤‡è€—æ—¶: $((END_TIME - START_TIME))ç§’"
          } &
          SOURCE_PID=$!

          {
            # ä»»åŠ¡2ï¼šå‡†å¤‡feedsé…ç½®
            echo "ğŸ“ [2/3] å‡†å¤‡feedsé…ç½®..."

            # åˆ›å»ºä¸´æ—¶ç›®å½•
            mkdir -p feeds_temp
            cd feeds_temp

            # å¤åˆ¶åŸºç¡€é…ç½®
            if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
              cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
              echo "âœ… ä½¿ç”¨è‡ªå®šä¹‰feedsé…ç½®"
            else
              # åˆ›å»ºåŸºç¡€é…ç½®
              cat > feeds.conf.default << 'EOF'
          src-git packages https://github.com/immortalwrt/packages.git;openwrt-24.10
          src-git luci https://github.com/immortalwrt/luci.git;openwrt-24.10
          src-git routing https://github.com/openwrt/routing.git;openwrt-24.10
          src-git telephony https://github.com/openwrt/telephony.git;openwrt-24.10
          EOF
              echo "âœ… ä½¿ç”¨é»˜è®¤feedsé…ç½®"
            fi

            # åŠ¨æ€æ·»åŠ feeds
            if [ "${{ inputs.enable_mihomo }}" = "true" ]; then
              echo 'src-git mihomo https://github.com/morytyann/OpenWrt-mihomo.git;main' >> feeds.conf.default
              echo "âœ… æ·»åŠ mihomo feed"
            fi
            if [ "${{ inputs.enable_qmodem_next }}" = "true" ] || [ "${{ inputs.enable_qmodem }}" = "true" ]; then
              echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
              echo "âœ… æ·»åŠ qmodem feed"
            fi

            echo "âœ… Feedsé…ç½®å‡†å¤‡å®Œæˆ"
          } &
          FEEDS_PID=$!

          # ç­‰å¾…å‰ä¸¤ä¸ªä»»åŠ¡å®Œæˆ
          echo "â³ ç­‰å¾…æºç å’Œé…ç½®å‡†å¤‡å®Œæˆ..."
          wait $SOURCE_PID $FEEDS_PID

          # åº”ç”¨feedsé…ç½®
          cd $SOURCE_DIR
          cp feeds_temp/feeds.conf.default ./feeds.conf.default
          echo "âœ… Feedsé…ç½®å·²åº”ç”¨"

          # ä»»åŠ¡3ï¼šæ›´æ–°feedsï¼ˆå¦‚æœéœ€è¦ï¼‰
          set +e
          if [ ! -d "staging_dir/host" ] || [ "${{ needs.analyze.outputs.needs-rebuild }}" = "true" ]; then
            echo "ğŸ”„ [3/3] æ›´æ–°feeds..."
            START_TIME=$(date +%s)

            # ä¼˜åŒ–feedsæ›´æ–°
            echo "ğŸ“Š å¼€å§‹feeds update..."
            timeout 300 ./scripts/feeds update -a &
            UPDATE_PID=$!

            # ç­‰å¾…ä¸€æ®µæ—¶é—´åå¼€å§‹install
            sleep 60

            echo "ğŸ“¦ å¼€å§‹feeds install..."
            timeout 600 ./scripts/feeds install -a -f &
            INSTALL_PID=$!

            # ç›‘æ§è¿›åº¦
            while kill -0 $UPDATE_PID 2>/dev/null || kill -0 $INSTALL_PID 2>/dev/null; do
              sleep 30
              echo "â³ Feedsæ›´æ–°è¿›è¡Œä¸­..."

              # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
              if [ -d "dl" ]; then
                DL_SIZE=$(du -sh dl 2>/dev/null | cut -f1)
                echo "ğŸ“ DLç›®å½•å¤§å°: $DL_SIZE"
              fi
            done

            # ç­‰å¾…å®Œæˆ
            wait $UPDATE_PID 2>/dev/null
            wait $INSTALL_PID 2>/dev/null

            END_TIME=$(date +%s)
            echo "â±ï¸ Feedsæ›´æ–°è€—æ—¶: $((END_TIME - START_TIME))ç§’"

            # æ£€æŸ¥ç»“æœ
            if [ -d "staging_dir/host" ]; then
              echo "âœ… Feedsæ›´æ–°æˆåŠŸ"
            else
              echo "âš ï¸ Feedsæ›´æ–°æœªå®Œå…¨æˆåŠŸï¼Œå°è¯•å¿«é€Ÿä¿®å¤..."
              timeout 120 ./scripts/feeds install -a || echo "âš ï¸ å¿«é€Ÿä¿®å¤ä¹Ÿå¤±è´¥ï¼Œç»§ç»­æ„å»º"
            fi
          else
            echo "âœ… Feedså·²å­˜åœ¨ä¸”æœ€æ–°ï¼Œè·³è¿‡æ›´æ–°"
          fi

          set -e

          # æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
          echo "ğŸ“Š å‡†å¤‡å®ŒæˆçŠ¶æ€:"
          echo "- æºç ç›®å½•: $([ -d "$SOURCE_DIR/.git" ] && echo "âœ… å­˜åœ¨" || echo "âŒ ç¼ºå¤±")"
          echo "- Feedsé…ç½®: $([ -f "$SOURCE_DIR/feeds.conf.default" ] && echo "âœ… å­˜åœ¨" || echo "âŒ ç¼ºå¤±")"
          echo "- Stagingç›®å½•: $([ -d "$SOURCE_DIR/staging_dir/host" ] && echo "âœ… å­˜åœ¨" || echo "âš ï¸ ç¼ºå¤±")"

          echo "âœ… æºç å’Œä¾èµ–å‡†å¤‡å®Œæˆ"

      - name: ä¿®å¤ä¾èµ–å’Œè¡¥ä¸
        run: |
          cd $SOURCE_DIR
          echo "ğŸ”§ åº”ç”¨ä¿®å¤è¡¥ä¸..."

          # AdGuardHome ç›¸å…³
          if [ "${{ inputs.enable_adguardhome }}" = "true" ] && [ ! -d "package/luci-app-adguardhome" ]; then
            git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome || true
          fi

          # ç§»é™¤é—®é¢˜åŒ…
          rm -rf package/feeds/packages/{exim,onionshare-cli,python-zope-event,python-zope-interface} 2>/dev/null || true

          # QModem ä¿®å¤
          rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true
          QMODEM_MK="package/feeds/qmodem/qmodem/Makefile"
          [ -f "$QMODEM_MK" ] && sed -i 's/DEPENDS:=.*+kmod-mhi-wwan/# &/g' "$QMODEM_MK" || true

          # mt_hwifi ä¾èµ–ä¿®å¤
          MT_HWIFI_MK="package/mtk/drivers/mt_hwifi/Makefile"
          [ -f "$MT_HWIFI_MK" ] && sed -i 's/+kmod-mt_wifi_osal//g' "$MT_HWIFI_MK" || true

          echo "âœ… è¡¥ä¸åº”ç”¨å®Œæˆ"

      - name: é…ç½®æ„å»º
        run: |
          cd $SOURCE_DIR
          echo "âš™ï¸ é…ç½®æ„å»ºé€‰é¡¹..."

          # éªŒè¯äº’æ–¥é€‰é¡¹
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] && [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨ QModem Next å’Œ QModemï¼"
            exit 1
          fi

          # ä¸‹è½½åŸºç¡€é…ç½®
          curl -fsSL "$CONFIG_URL" -o base.config || {
            [ -f "defconfig/mt7987_mt7992.config" ] && cp defconfig/mt7987_mt7992.config base.config
          }

          cat base.config > .config

          # åº”ç”¨é¢å¤–é…ç½®
          if [ -f "$GITHUB_WORKSPACE/h5000m.extra.config" ]; then
            cat "$GITHUB_WORKSPACE/h5000m.extra.config" >> .config
          fi

          # é…ç½®å‡½æ•°
          enable_pkg() { echo "CONFIG_PACKAGE_$1=y" >> .config; }
          disable_pkg() { echo "# CONFIG_PACKAGE_$1 is not set" >> .config; }

          # åº”ç”¨ç”¨æˆ·é…ç½®
          [ "${{ inputs.enable_adguardhome }}" = "true" ] && { enable_pkg "luci-app-adguardhome"; enable_pkg "adguardhome"; }
          [ "${{ inputs.enable_openclash }}" = "true" ] && {
            enable_pkg "luci-app-openclash"
            enable_pkg "bash"
            enable_pkg "dnsmasq-full"
            enable_pkg "curl"
            enable_pkg "ca-bundle"
            enable_pkg "ip-full"
            enable_pkg "kmod-nft-tproxy"
            enable_pkg "luci-compat"
          }
          [ "${{ inputs.enable_mihomo }}" = "true" ] && { enable_pkg "mihomo"; enable_pkg "luci-app-mihomo"; }
          [ "${{ inputs.enable_upnp }}" = "true" ] && enable_pkg "luci-app-upnp" || disable_pkg "luci-app-upnp"
          [ "${{ inputs.enable_vlmcsd }}" = "true" ] && { enable_pkg "vlmcsd"; enable_pkg "luci-app-vlmcsd"; }
          [ "${{ inputs.enable_mosdns }}" = "true" ] && { enable_pkg "mosdns"; enable_pkg "luci-app-mosdns"; }
          [ "${{ inputs.enable_dockerman }}" = "true" ] && { enable_pkg "docker"; enable_pkg "luci-app-dockerman"; }
          [ "${{ inputs.enable_qmodem_next }}" = "true" ] && enable_pkg "luci-app-qmodem-next"
          [ "${{ inputs.enable_qmodem }}" = "true" ] && enable_pkg "luci-app-qmodem"
          [ "${{ inputs.enable_mwan }}" = "true" ] && { enable_pkg "mwan3"; enable_pkg "luci-app-mwan3"; }

          make defconfig
          echo "âœ… é…ç½®å®Œæˆ"

          - name: æ™ºèƒ½ç¼–è¯‘
            timeout-minutes: ${{ inputs.max_build_time }}
            run: |
              cd $SOURCE_DIR
              THREADS=${{ needs.analyze.outputs.optimal-threads }}
              export PATH="/usr/lib/ccache:$PATH"

              # è®¾ç½®ccache
              ccache --set-config=max_size=8G || true
              ccache --set-config=compression=true || true

              echo "ğŸ”¨ å¼€å§‹æ„å»º (æ¨¡å¼: ${{ needs.analyze.outputs.build-strategy }})..."
              START_TIME=$(date +%s)

              # æ™ºèƒ½æ¸…ç†
              case "${{ needs.analyze.outputs.clean-level }}" in
                "full")
                  make clean || true
                  rm -rf build_dir/* || true
                  ;;
                "minimal")
                  rm -rf build_dir/target-* || true
                  ;;
                "none")
                  echo "è·³è¿‡æ¸…ç†"
                  ;;
              esac

              # ä¸‹è½½ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
              if [ ! "$(ls -A dl 2>/dev/null)" ] || [ "${{ needs.analyze.outputs.use-incremental }}" != "true" ]; then
                echo "ğŸ“¦ ä¸‹è½½ä¾èµ–..."
                make download -j$((THREADS * 2)) || {
                  find dl -size -1024c -delete 2>/dev/null || true
                  make download -j$((THREADS * 2)) || echo "ä¸‹è½½å¤±è´¥ï¼Œç»§ç»­å°è¯•ç¼–è¯‘"
                }
              fi

              # æ ¹æ®ç­–ç•¥ç¼–è¯‘
              if [ "${{ needs.analyze.outputs.build-strategy }}" = "parallel" ]; then
                echo "ğŸš€ å¹¶è¡Œç¼–è¯‘æ¨¡å¼..."
                # å¹¶è¡Œç¼–è¯‘targetå’Œpackages
                make -j$THREADS target/compile BUILD_LOG=1 &
                TARGET_PID=$!
                make -j$THREADS package/compile BUILD_LOG=1 &
                PACKAGES_PID=$!
                wait $TARGET_PID $PACKAGES_PID
              elif [ "${{ needs.analyze.outputs.use-incremental }}" = "true" ]; then
                echo "âš¡ å¢é‡ç¼–è¯‘æ¨¡å¼..."
                make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || {
                  echo "âš ï¸ å¢é‡ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å®Œæ•´ç¼–è¯‘..."
                  make -j$THREADS BUILD_LOG=1
                }
              else
                echo "ğŸ”¨ å®Œæ•´ç¼–è¯‘æ¨¡å¼..."
                make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || {
                  echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
                  make -j1 V=s || {
                    echo "âŒ ç¼–è¯‘å¤±è´¥"
                    exit 1
                  }
                }
              fi

              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              echo "âœ… ç¼–è¯‘å®Œæˆ (è€—æ—¶: ${DURATION}s)"

          - name: ä¸Šä¼ æ„å»ºç¼“å­˜
            if: always()
            uses: actions/cache/save@v4
            with:
              path: |
                ${{ env.SOURCE_DIR }}/dl
                ${{ env.SOURCE_DIR }}/staging_dir
                ~/.ccache
              key: ${{ runner.os }}-build-v3-${{ env.REPO_BRANCH }}-${{ needs.analyze.outputs.config-hash }}-${{ github.run_id }}

            - name: æ”¶é›†äº§ç‰©
              if: success()
              run: |
                cd $SOURCE_DIR

                if [ ! -d "bin/targets" ]; then
                  echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡º"
                  exit 1
                fi

                mkdir -p $GITHUB_WORKSPACE/artifacts
                find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} $GITHUB_WORKSPACE/artifacts/ \;

                # éªŒè¯äº§ç‰©
                if [ -z "$(ls -A $GITHUB_WORKSPACE/artifacts/ 2>/dev/null)" ]; then
                  echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
                  exit 1
                fi

                # ç”Ÿæˆæ¸…å•
                cat > $GITHUB_WORKSPACE/artifacts/MANIFEST.txt << 'EOF'
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘    ImmortalWrt H5000M æ™ºèƒ½æ„å»ºæŠ¥å‘Š             â•‘
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                ğŸ“… æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
                ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}
                ğŸ·ï¸  Build #: ${{ github.run_number }}

                ğŸ¯ æ„å»ºç­–ç•¥: ${{ needs.analyze.outputs.build-strategy }}
                âš¡ å¢é‡æ¨¡å¼: ${{ needs.analyze.outputs.use-incremental }}
                ğŸ’¾ æ¸…ç†çº§åˆ«: ${{ needs.analyze.outputs.clean-level }}
                ğŸ”§ ä¼˜åŒ–çº¿ç¨‹: ${{ needs.analyze.outputs.optimal-threads }}

                ğŸ“Š ç¼“å­˜çŠ¶æ€:
                â€¢ DLç¼“å­˜: ${{ needs.analyze.outputs.cache-hit-dl == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}
                â€¢ Toolchainç¼“å­˜: ${{ needs.analyze.outputs.cache-hit-toolchain == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}
                â€¢ ccacheç¼“å­˜: ${{ needs.analyze.outputs.cache-hit-ccache == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}

                âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:
                â€¢ AdGuardHome: ${{ inputs.enable_adguardhome }}
                â€¢ OpenClash: ${{ inputs.enable_openclash }}
                â€¢ Mihomo: ${{ inputs.enable_mihomo }}
                â€¢ UPnP: ${{ inputs.enable_upnp }}
                â€¢ VLMCSd: ${{ inputs.enable_vlmcsd }}
                â€¢ MosDNS: ${{ inputs.enable_mosdns }}
                â€¢ DockerMan: ${{ inputs.enable_dockerman }}
                â€¢ QModem Next: ${{ inputs.enable_qmodem_next }}
                â€¢ QModem: ${{ inputs.enable_qmodem }}
                â€¢ MWAN: ${{ inputs.enable_mwan }}

                ğŸ“¦ äº§ç‰©æ–‡ä»¶:
                EOF

                cd $GITHUB_WORKSPACE/artifacts
                ls -lh *.bin *.img.gz 2>/dev/null | awk '{print "  â€¢ " $9 " (" $5 ")"}' >> MANIFEST.txt || echo "  (æ— äº§ç‰©æ–‡ä»¶)" >> MANIFEST.txt

                echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ:"
                ls -lh

            - name: ä¸Šä¼ æ„å»ºç»“æœ
              uses: actions/upload-artifact@v4
              if: success()
              with:
                name: ImmortalWrt-H5000M-${{ github.run_number }}
                path: artifacts/
                retention-days: 30

            - name: åˆ›å»º GitHub Release
              uses: softprops/action-gh-release@v1
              if: success()
              with:
                tag_name: v${{ github.run_number }}
                name: ImmortalWrt H5000M #${{ github.run_number }} [${{ needs.analyze.outputs.build-strategy }}]
                body: |
                  ğŸ‰ **ImmortalWrt H5000M å›ºä»¶å·²æ„å»ºå®Œæˆ**

                  ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
                  ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}

                  **ğŸ¯ æ„å»ºä¿¡æ¯:**
                  - ç­–ç•¥: ${{ needs.analyze.outputs.build-strategy }}
                  - ä¼˜åŒ–: ${{ needs.analyze.outputs.use-incremental == 'true' && 'å¢é‡' || 'å®Œæ•´' }}
                  - çº¿ç¨‹: ${{ needs.analyze.outputs.optimal-threads }}

                  **âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:**
                  - AdGuardHome: ${{ inputs.enable_adguardhome }}
                  - OpenClash: ${{ inputs.enable_openclash }}
                  - Mihomo: ${{ inputs.enable_mihomo }}
                  - UPnP: ${{ inputs.enable_upnp }}
                  - VLMCSd: ${{ inputs.enable_vlmcsd }}
                  - MosDNS: ${{ inputs.enable_mosdns }}
                  - Docker: ${{ inputs.enable_dockerman }}
                  - MWAN: ${{ inputs.enable_mwan }}

                  ğŸ’¾ ä¸‹è½½äº§ç‰©: è§ä¸‹æ–¹ Artifacts
                  ğŸ“‹ è¯¦ç»†ä¿¡æ¯: è§ MANIFEST.txt
                prerelease: false
                files: artifacts/*
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}