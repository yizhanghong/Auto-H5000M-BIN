name: Build ImmortalWrt H5000M (Ultimate)

on:
  schedule:
    - cron: '0 16 * * 0'  # æ¯å‘¨ä¸€åŒ—äº¬æ—¶é—´ 00:00
  workflow_dispatch:
    inputs:
      # æ ¸å¿ƒåŠŸèƒ½å¼€å…³
      enable_adguardhome:
        description: 'å¯ç”¨ AdGuardHome'
        required: false
        default: true
        type: boolean
      enable_openclash:
        description: 'å¯ç”¨ OpenClash'
        required: false
        default: true
        type: boolean
      enable_mihomo:
        description: 'å¯ç”¨ Mihomo'
        required: false
        default: false
        type: boolean
      enable_upnp:
        description: 'å¯ç”¨ UPnP'
        required: false
        default: true
        type: boolean
      enable_vlmcsd:
        description: 'å¯ç”¨ VLMCSd'
        required: false
        default: true
        type: boolean
      enable_mosdns:
        description: 'å¯ç”¨ MosDNS'
        required: false
        default: true
        type: boolean
      enable_dockerman:
        description: 'å¯ç”¨ DockerMan'
        required: false
        default: false
        type: boolean
      enable_qmodem_next:
        description: 'å¯ç”¨ QModem Next (æ–°ç‰ˆ)'
        required: false
        default: true
        type: boolean
      enable_qmodem:
        description: 'å¯ç”¨ QModem (æ—§ç‰ˆ)'
        required: false
        default: false
        type: boolean
      enable_mwan:
        description: 'å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)'
        required: false
        default: true
        type: boolean

      # æ™ºèƒ½æ§åˆ¶å‚æ•°
      build_mode:
        description: 'æ„å»ºæ¨¡å¼'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto  # è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ¨¡å¼
        - fast  # å¿«é€Ÿæ¨¡å¼ï¼ˆå¢é‡æ„å»ºï¼‰
        - full  # å®Œæ•´æ¨¡å¼ï¼ˆé‡æ–°æ„å»ºï¼‰
        - parallel  # å¹¶è¡Œæ¨¡å¼ï¼ˆå¤šJobï¼‰

      clean_level:
        description: 'æ¸…ç†çº§åˆ«'
        required: false
        default: 'smart'
        type: choice
        options:
        - smart  # æ™ºèƒ½æ¸…ç†
        - minimal  # æœ€å°æ¸…ç†
        - full  # å®Œå…¨æ¸…ç†
        - none  # ä¸æ¸…ç†

      # é«˜çº§é€‰é¡¹
      enable_cache_optimization:
        description: 'å¯ç”¨ç¼“å­˜ä¼˜åŒ–'
        required: false
        default: true
        type: boolean
      max_build_time:
        description: 'æœ€å¤§æ„å»ºæ—¶é—´(åˆ†é’Ÿ)'
        required: false
        default: 120
        type: number

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_URL: https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/refs/heads/mt798x-mt799x-6.6-mtwifi/defconfig/mt7987_mt7992.config
  SOURCE_DIR: immortalwrt
  TZ: Asia/Shanghai
  BUILD_ID: ${{ github.run_id }}

jobs:
  # Job 1: æ™ºèƒ½åˆ†æå’Œå†³ç­–
  analyze:
    name: ğŸ§  æ™ºèƒ½åˆ†æ
    runs-on: ubuntu-22.04
    outputs:
      # ç¼“å­˜çŠ¶æ€
      cache-hit-dl: ${{ steps.cache-dl.outputs.cache-hit }}
      cache-hit-toolchain: ${{ steps.cache-toolchain.outputs.cache-hit }}
      cache-hit-ccache: ${{ steps.cache-ccache.outputs.cache-hit }}

      # æ„å»ºå†³ç­–
      build-strategy: ${{ steps.decide.outputs.strategy }}
      use-parallel: ${{ steps.decide.outputs.use-parallel }}
      use-incremental: ${{ steps.decide.outputs.use-incremental }}
      clean-level: ${{ steps.decide.outputs.clean-level }}

      # æ€§èƒ½å‚æ•°
      optimal-threads: ${{ steps.performance.outputs.threads }}
      estimated-time: ${{ steps.performance.outputs.estimated-time }}

      # é…ç½®å“ˆå¸Œ
      config-hash: ${{ steps.config.outputs.hash }}
      needs-rebuild: ${{ steps.config.outputs.needs-rebuild }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¡ç®—é…ç½®å“ˆå¸Œ
        id: config
        run: |
          CONFIG_STRING="${{ inputs.enable_adguardhome }}${{ inputs.enable_openclash }}${{ inputs.enable_mihomo }}"
          CONFIG_STRING="${CONFIG_STRING}${{ inputs.enable_upnp }}${{ inputs.enable_vlmcsd }}${{ inputs.enable_mosdns }}"
          CONFIG_STRING="${CONFIG_STRING}${{ inputs.enable_dockerman }}${{ inputs.enable_qmodem_next }}${{ inputs.enable_qmodem }}"
          CONFIG_STRING="${CONFIG_STRING}${{ inputs.enable_mwan }}${{ inputs.build_mode }}${{ inputs.clean_level }}"

          HASH=$(echo "$CONFIG_STRING" | md5sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

          # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å»º
          if [ "${{ inputs.build_mode }}" = "full" ] || [ "${{ inputs.clean_level }}" = "full" ]; then
            echo "needs-rebuild=true" >> $GITHUB_OUTPUT
          else
            echo "needs-rebuild=false" >> $GITHUB_OUTPUT
          fi

          echo "ğŸ“‹ é…ç½®å“ˆå¸Œ: $HASH"

      - name: ç¼“å­˜æ£€æŸ¥ - ä¸‹è½½æ–‡ä»¶
        uses: actions/cache@v4
        id: cache-dl
        with:
          path: ${{ env.SOURCE_DIR }}/dl
          key: ${{ runner.os }}-dl-v3-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-dl-v3-${{ env.REPO_BRANCH }}-

      - name: ç¼“å­˜æ£€æŸ¥ - Toolchain
        uses: actions/cache@v4
        id: cache-toolchain
        with:
          path: |
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
          key: ${{ runner.os }}-toolchain-v3-${{ env.REPO_BRANCH }}
          restore-keys: |
            ${{ runner.os }}-toolchain-v3-${{ env.REPO_BRANCH }}-

      - name: ç¼“å­˜æ£€æŸ¥ - ccache
        uses: actions/cache@v4
        id: cache-ccache
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-v3-${{ env.REPO_BRANCH }}
          restore-keys: |
            ${{ runner.os }}-ccache-v3-${{ env.REPO_BRANCH }}-

      - name: æ™ºèƒ½å†³ç­–
        id: decide
        run: |
          CACHE_HIT_COUNT=0
          [ "${{ steps.cache-dl.outputs.cache-hit }}" = "true" ] && ((CACHE_HIT_COUNT++))
          [ "${{ steps.cache-toolchain.outputs.cache-hit }}" = "true" ] && ((CACHE_HIT_COUNT++))
          [ "${{ steps.cache-ccache.outputs.cache-hit }}" = "true" ] && ((CACHE_HIT_COUNT++))

          echo "ğŸ“Š ç¼“å­˜å‘½ä¸­: $CACHE_HIT_COUNT/3"

          # æ™ºèƒ½å†³ç­–é€»è¾‘
          if [ "${{ inputs.build_mode }}" != "auto" ]; then
            # ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®šæ¨¡å¼
            STRATEGY="${{ inputs.build_mode }}"
          elif [ $CACHE_HIT_COUNT -ge 2 ] && [ "${{ steps.config.outputs.needs-rebuild }}" = "false" ]; then
            # ç¼“å­˜è‰¯å¥½ï¼Œä½¿ç”¨å¹¶è¡Œæ¨¡å¼
            STRATEGY="parallel"
          elif [ $CACHE_HIT_COUNT -ge 1 ] && [ "${{ steps.config.outputs.needs-rebuild }}" = "false" ]; then
            # éƒ¨åˆ†ç¼“å­˜ï¼Œä½¿ç”¨å¿«é€Ÿæ¨¡å¼
            STRATEGY="fast"
          else
            # ç¼“å­˜ä¸ä½³æˆ–éœ€è¦é‡å»ºï¼Œä½¿ç”¨å®Œæ•´æ¨¡å¼
            STRATEGY="full"
          fi

          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT

          # å†³å®šæ˜¯å¦ä½¿ç”¨å¹¶è¡Œ
          if [ "$STRATEGY" = "parallel" ] && [ "${{ inputs.enable_cache_optimization }}" = "true" ]; then
            echo "use-parallel=true" >> $GITHUB_OUTPUT
          else
            echo "use-parallel=false" >> $GITHUB_OUTPUT
          fi

          # å†³å®šæ˜¯å¦ä½¿ç”¨å¢é‡
          if [ "$STRATEGY" != "full" ] && [ "${{ steps.config.outputs.needs-rebuild }}" = "false" ]; then
            echo "use-incremental=true" >> $GITHUB_OUTPUT
          else
            echo "use-incremental=false" >> $GITHUB_OUTPUT
          fi

          # å†³å®šæ¸…ç†çº§åˆ«
          if [ "${{ inputs.clean_level }}" != "smart" ]; then
            echo "clean-level=${{ inputs.clean_level }}" >> $GITHUB_OUTPUT
          elif [ $CACHE_HIT_COUNT -eq 0 ]; then
            echo "clean-level=none" >> $GITHUB_OUTPUT
          else
            echo "clean-level=minimal" >> $GITHUB_OUTPUT
          fi

          echo "ğŸ¯ æ„å»ºç­–ç•¥: $STRATEGY"

      - name: æ€§èƒ½ä¼˜åŒ–å‚æ•°
        id: performance
        run: |
          # æ ¹æ®å¯ç”¨èµ„æºè®¡ç®—æœ€ä¼˜çº¿ç¨‹æ•°
          AVAILABLE_CORES=$(nproc)
          AVAILABLE_MEM=$(free -g | awk '/Mem:/ {print $7}')

          if [ "$AVAILABLE_MEM" -gt 12 ]; then
            # å†…å­˜å……è¶³ï¼Œå¯ä»¥ä½¿ç”¨æ›´å¤šçº¿ç¨‹
                THREADS=$((AVAILABLE_CORES * 2))
          elif [ "$AVAILABLE_MEM" -gt 6 ]; then
            # å†…å­˜é€‚ä¸­
                THREADS=$((AVAILABLE_CORES + 1))
          else
            # å†…å­˜æœ‰é™ï¼Œå‡å°‘çº¿ç¨‹æ•°
                THREADS=$AVAILABLE_CORES
          fi

          echo "threads=$THREADS" >> $GITHUB_OUTPUT

          # ä¼°ç®—æ„å»ºæ—¶é—´
          if [ "${{ steps.decide.outputs.strategy }}" = "full" ]; then
            ESTIMATED_TIME=90
          elif [ "${{ steps.decide.outputs.strategy }}" = "parallel" ]; then
            ESTIMATED_TIME=30
          else
            ESTIMATED_TIME=45
          fi

          echo "estimated-time=$ESTIMATED_TIME" >> $GITHUB_OUTPUT

          echo "ğŸ’» æœ€ä¼˜çº¿ç¨‹æ•°: $THREADS"
          echo "â±ï¸ é¢„è®¡æ—¶é—´: ${ESTIMATED_TIME}åˆ†é’Ÿ"

  # Job 2: ç»Ÿä¸€æ„å»ºï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
  build:
    name: ğŸ”¨ æ™ºèƒ½æ„å»º
    runs-on: ubuntu-22.04
    needs: analyze
    if: always() && needs.analyze.result == 'success'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir
            ~/.ccache
          key: ${{ runner.os }}-build-v3-${{ env.REPO_BRANCH }}-${{ needs.analyze.outputs.config-hash }}
          restore-keys: |
            ${{ runner.os }}-build-v3-${{ env.REPO_BRANCH }}-

      - name: ç¯å¢ƒå‡†å¤‡
        run: |
          echo "ğŸ”§ å‡†å¤‡æ„å»ºç¯å¢ƒ..."

          # åŸºç¡€æ¸…ç†
          sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
          docker system prune -f 2>/dev/null || true

          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "ğŸ’¾ å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"

          if [ "$AVAIL_GB" -lt 8 ]; then
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘8GB"
            exit 1
          fi

          # å®‰è£…ä¾èµ–
          sudo apt-get update -qq
          sudo apt-get install -y build-essential git ccache python3 python3-pip \
            libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev rustc cargo \
            golang-go autoconf automake libtool patch make gcc g++

      - name: æºç å’Œä¾èµ–å‡†å¤‡
        run: |
          echo "ğŸ“¥ å‡†å¤‡æºç å’Œä¾èµ–..."

          # å…‹éš†æˆ–æ›´æ–°æºç 
          if [ ! -d "$SOURCE_DIR/.git" ]; then
            echo "ğŸ“¥ å…‹éš†æºç ..."
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          else
            echo "ğŸ“¥ æ›´æ–°æºç ..."
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fd
          fi

          # è®¾ç½®feeds
          cd $SOURCE_DIR
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          fi

          # åŠ¨æ€æ·»åŠ feeds
          if [ "${{ inputs.enable_mihomo }}" = "true" ] && ! grep -q "mihomo" feeds.conf.default 2>/dev/null; then
            echo 'src-git mihomo https://github.com/morytyann/OpenWrt-mihomo.git;main' >> feeds.conf.default
          fi
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] || [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            if ! grep -q "qmodem" feeds.conf.default 2>/dev/null; then
              echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
            fi
          fi

          # æ›´æ–°feedsï¼ˆå¦‚æœéœ€è¦ï¼‰
          if [ ! -d "staging_dir/host" ] || [ "${{ needs.analyze.outputs.needs-rebuild }}" = "true" ]; then
            echo "ğŸ”„ æ›´æ–°feeds..."
            ./scripts/feeds update -a || echo "feeds update failed"
            ./scripts/feeds install -a -f || echo "feeds install failed"
          else
            echo "âœ… feedså·²å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°"
          fi

      - name: ä¿®å¤ä¾èµ–å’Œè¡¥ä¸
        run: |
          cd $SOURCE_DIR
          echo "ğŸ”§ åº”ç”¨ä¿®å¤è¡¥ä¸..."

          # AdGuardHome ç›¸å…³
          if [ "${{ inputs.enable_adguardhome }}" = "true" ] && [ ! -d "package/luci-app-adguardhome" ]; then
            git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome || true
          fi

          # ç§»é™¤é—®é¢˜åŒ…
          rm -rf package/feeds/packages/{exim,onionshare-cli,python-zope-event,python-zope-interface} 2>/dev/null || true

          # QModem ä¿®å¤
          rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true
          QMODEM_MK="package/feeds/qmodem/qmodem/Makefile"
          [ -f "$QMODEM_MK" ] && sed -i 's/DEPENDS:=.*+kmod-mhi-wwan/# &/g' "$QMODEM_MK" || true

          # mt_hwifi ä¾èµ–ä¿®å¤
          MT_HWIFI_MK="package/mtk/drivers/mt_hwifi/Makefile"
          [ -f "$MT_HWIFI_MK" ] && sed -i 's/+kmod-mt_wifi_osal//g' "$MT_HWIFI_MK" || true

          echo "âœ… è¡¥ä¸åº”ç”¨å®Œæˆ"

      - name: é…ç½®æ„å»º
        run: |
          cd $SOURCE_DIR
          echo "âš™ï¸ é…ç½®æ„å»ºé€‰é¡¹..."

          # éªŒè¯äº’æ–¥é€‰é¡¹
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] && [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨ QModem Next å’Œ QModemï¼"
            exit 1
          fi

          # ä¸‹è½½åŸºç¡€é…ç½®
          curl -fsSL "$CONFIG_URL" -o base.config || {
            [ -f "defconfig/mt7987_mt7992.config" ] && cp defconfig/mt7987_mt7992.config base.config
          }

          cat base.config > .config

          # åº”ç”¨é¢å¤–é…ç½®
          if [ -f "$GITHUB_WORKSPACE/h5000m.extra.config" ]; then
            cat "$GITHUB_WORKSPACE/h5000m.extra.config" >> .config
          fi

          # é…ç½®å‡½æ•°
          enable_pkg() { echo "CONFIG_PACKAGE_$1=y" >> .config; }
          disable_pkg() { echo "# CONFIG_PACKAGE_$1 is not set" >> .config; }

          # åº”ç”¨ç”¨æˆ·é…ç½®
          [ "${{ inputs.enable_adguardhome }}" = "true" ] && { enable_pkg "luci-app-adguardhome"; enable_pkg "adguardhome"; }
          [ "${{ inputs.enable_openclash }}" = "true" ] && {
            enable_pkg "luci-app-openclash"
            enable_pkg "bash"
            enable_pkg "dnsmasq-full"
            enable_pkg "curl"
            enable_pkg "ca-bundle"
            enable_pkg "ip-full"
            enable_pkg "kmod-nft-tproxy"
            enable_pkg "luci-compat"
          }
          [ "${{ inputs.enable_mihomo }}" = "true" ] && { enable_pkg "mihomo"; enable_pkg "luci-app-mihomo"; }
          [ "${{ inputs.enable_upnp }}" = "true" ] && enable_pkg "luci-app-upnp" || disable_pkg "luci-app-upnp"
          [ "${{ inputs.enable_vlmcsd }}" = "true" ] && { enable_pkg "vlmcsd"; enable_pkg "luci-app-vlmcsd"; }
          [ "${{ inputs.enable_mosdns }}" = "true" ] && { enable_pkg "mosdns"; enable_pkg "luci-app-mosdns"; }
          [ "${{ inputs.enable_dockerman }}" = "true" ] && { enable_pkg "docker"; enable_pkg "luci-app-dockerman"; }
          [ "${{ inputs.enable_qmodem_next }}" = "true" ] && enable_pkg "luci-app-qmodem-next"
          [ "${{ inputs.enable_qmodem }}" = "true" ] && enable_pkg "luci-app-qmodem"
          [ "${{ inputs.enable_mwan }}" = "true" ] && { enable_pkg "mwan3"; enable_pkg "luci-app-mwan3"; }

          make defconfig
          echo "âœ… é…ç½®å®Œæˆ"

      - name: æ™ºèƒ½ç¼–è¯‘
        timeout-minutes: ${{ inputs.max_build_time }}
        run: |
          cd $SOURCE_DIR
          THREADS=${{ needs.analyze.outputs.optimal-threads }}
          export PATH="/usr/lib/ccache:$PATH"

          # è®¾ç½®ccache
          ccache --set-config=max_size=8G || true
          ccache --set-config=compression=true || true

          echo "ğŸ”¨ å¼€å§‹æ„å»º (æ¨¡å¼: ${{ needs.analyze.outputs.build-strategy }})..."
          START_TIME=$(date +%s)

          # æ™ºèƒ½æ¸…ç†
          case "${{ needs.analyze.outputs.clean-level }}" in
            "full")
              make clean || true
              rm -rf build_dir/* || true
              ;;
            "minimal")
              rm -rf build_dir/target-* || true
              ;;
            "none")
              echo "è·³è¿‡æ¸…ç†"
              ;;
          esac

          # ä¸‹è½½ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if [ ! "$(ls -A dl 2>/dev/null)" ] || [ "${{ needs.analyze.outputs.use-incremental }}" != "true" ]; then
            echo "ğŸ“¦ ä¸‹è½½ä¾èµ–..."
            make download -j$((THREADS * 2)) || {
              find dl -size -1024c -delete 2>/dev/null || true
              make download -j$((THREADS * 2)) || echo "ä¸‹è½½å¤±è´¥ï¼Œç»§ç»­å°è¯•ç¼–è¯‘"
            }
          fi

          # æ ¹æ®ç­–ç•¥ç¼–è¯‘
          if [ "${{ needs.analyze.outputs.build-strategy }}" = "parallel" ]; then
            echo "ğŸš€ å¹¶è¡Œç¼–è¯‘æ¨¡å¼..."
            # å¹¶è¡Œç¼–è¯‘targetå’Œpackages
            make -j$THREADS target/compile BUILD_LOG=1 &
            TARGET_PID=$!
            make -j$THREADS package/compile BUILD_LOG=1 &
            PACKAGES_PID=$!
            wait $TARGET_PID $PACKAGES_PID
          elif [ "${{ needs.analyze.outputs.use-incremental }}" = "true" ]; then
            echo "âš¡ å¢é‡ç¼–è¯‘æ¨¡å¼..."
            make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || {
              echo "âš ï¸ å¢é‡ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å®Œæ•´ç¼–è¯‘..."
              make -j$THREADS BUILD_LOG=1
            }
          else
            echo "ğŸ”¨ å®Œæ•´ç¼–è¯‘æ¨¡å¼..."
            make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || {
              echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
              make -j1 V=s || {
                echo "âŒ ç¼–è¯‘å¤±è´¥"
                exit 1
              }
            }
          fi

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… ç¼–è¯‘å®Œæˆ (è€—æ—¶: ${DURATION}s)"

      - name: ä¸Šä¼ æ„å»ºç¼“å­˜
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir
            ~/.ccache
          key: ${{ runner.os }}-build-v3-${{ env.REPO_BRANCH }}-${{ needs.analyze.outputs.config-hash }}-${{ github.run_id }}

      - name: æ”¶é›†äº§ç‰©
        if: success()
        run: |
          cd $SOURCE_DIR

          if [ ! -d "bin/targets" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡º"
            exit 1
          fi

          mkdir -p $GITHUB_WORKSPACE/artifacts
          find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} $GITHUB_WORKSPACE/artifacts/ \;

          # éªŒè¯äº§ç‰©
          if [ -z "$(ls -A $GITHUB_WORKSPACE/artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          fi

          # ç”Ÿæˆæ¸…å•
          cat > $GITHUB_WORKSPACE/artifacts/MANIFEST.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ImmortalWrt H5000M æ™ºèƒ½æ„å»ºæŠ¥å‘Š             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“… æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}
          ğŸ·ï¸  Build #: ${{ github.run_number }}

          ğŸ¯ æ„å»ºç­–ç•¥: ${{ needs.analyze.outputs.build-strategy }}
          âš¡ å¢é‡æ¨¡å¼: ${{ needs.analyze.outputs.use-incremental }}
          ğŸ’¾ æ¸…ç†çº§åˆ«: ${{ needs.analyze.outputs.clean-level }}
          ğŸ”§ ä¼˜åŒ–çº¿ç¨‹: ${{ needs.analyze.outputs.optimal-threads }}

          ğŸ“Š ç¼“å­˜çŠ¶æ€:
          â€¢ DLç¼“å­˜: ${{ needs.analyze.outputs.cache-hit-dl == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}
          â€¢ Toolchainç¼“å­˜: ${{ needs.analyze.outputs.cache-hit-toolchain == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}
          â€¢ ccacheç¼“å­˜: ${{ needs.analyze.outputs.cache-hit-ccache == 'true' && 'âœ… å‘½ä¸­' || 'âŒ æœªå‘½ä¸­' }}

          âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:
          â€¢ AdGuardHome: ${{ inputs.enable_adguardhome }}
          â€¢ OpenClash: ${{ inputs.enable_openclash }}
          â€¢ Mihomo: ${{ inputs.enable_mihomo }}
          â€¢ UPnP: ${{ inputs.enable_upnp }}
          â€¢ VLMCSd: ${{ inputs.enable_vlmcsd }}
          â€¢ MosDNS: ${{ inputs.enable_mosdns }}
          â€¢ DockerMan: ${{ inputs.enable_dockerman }}
          â€¢ QModem Next: ${{ inputs.enable_qmodem_next }}
          â€¢ QModem: ${{ inputs.enable_qmodem }}
          â€¢ MWAN: ${{ inputs.enable_mwan }}

          ğŸ“¦ äº§ç‰©æ–‡ä»¶:
          EOF

          cd $GITHUB_WORKSPACE/artifacts
          ls -lh *.bin *.img.gz 2>/dev/null | awk '{print "  â€¢ " $9 " (" $5 ")"}' >> MANIFEST.txt || echo "  (æ— äº§ç‰©æ–‡ä»¶)" >> MANIFEST.txt

          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ:"
          ls -lh

      - name: ä¸Šä¼ æ„å»ºç»“æœ
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImmortalWrt-H5000M-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt H5000M #${{ github.run_number }} [${{ needs.analyze.outputs.build-strategy }}]
          body: |
            ğŸ‰ **ImmortalWrt H5000M å›ºä»¶å·²æ„å»ºå®Œæˆ**

            ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
            ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}

            **ğŸ¯ æ„å»ºä¿¡æ¯:**
            - ç­–ç•¥: ${{ needs.analyze.outputs.build-strategy }}
            - ä¼˜åŒ–: ${{ needs.analyze.outputs.use-incremental == 'true' && 'å¢é‡' || 'å®Œæ•´' }}
            - çº¿ç¨‹: ${{ needs.analyze.outputs.optimal-threads }}

            **âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:**
            - AdGuardHome: ${{ inputs.enable_adguardhome }}
            - OpenClash: ${{ inputs.enable_openclash }}
            - Mihomo: ${{ inputs.enable_mihomo }}
            - UPnP: ${{ inputs.enable_upnp }}
            - VLMCSd: ${{ inputs.enable_vlmcsd }}
            - MosDNS: ${{ inputs.enable_mosdns }}
            - Docker: ${{ inputs.enable_dockerman }}
            - MWAN: ${{ inputs.enable_mwan }}

            ğŸ’¾ ä¸‹è½½äº§ç‰©: è§ä¸‹æ–¹ Artifacts
            ğŸ“‹ è¯¦ç»†ä¿¡æ¯: è§ MANIFEST.txt
          prerelease: false
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}