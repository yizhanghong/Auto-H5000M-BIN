name: Build ImmortalWrt H5000M

on:
  schedule:
    - cron: '0 16 * * 0'  # æ¯å‘¨ä¸€åŒ—äº¬æ—¶é—´ 00:00
  workflow_dispatch:
    inputs:
      enable_adguardhome:
        description: 'å¯ç”¨ AdGuardHome'
        required: false
        default: false
        type: boolean
      enable_openclash:
        description: 'å¯ç”¨ OpenClash'
        required: false
        default: false
        type: boolean
      enable_nikki:
        description: 'å¯ç”¨ Nikki'
        required: false
        default: false
        type: boolean
      enable_upnp:
        description: 'å¯ç”¨ UPnP'
        required: false
        default: false
        type: boolean
      enable_vlmcsd:
        description: 'å¯ç”¨ VLMCSd'
        required: false
        default: false
        type: boolean
      enable_mosdns:
        description: 'å¯ç”¨ MosDNS'
        required: false
        default: false
        type: boolean
      enable_dockerman:
        description: 'å¯ç”¨ DockerMan'
        required: false
        default: false
        type: boolean
      enable_qmodem_next:
        description: 'å¯ç”¨ QModem Next (æ–°ç‰ˆ)'
        required: false
        default: false
        type: boolean
      enable_qmodem:
        description: 'å¯ç”¨ QModem (æ—§ç‰ˆ)'
        required: false
        default: false
        type: boolean
      enable_mwan:
        description: 'å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)'
        required: false
        default: false
        type: boolean
      enable_homeproxy:
        description: 'å¯ç”¨ HomeProxy'
        required: false
        default: false
        type: boolean
      enable_adbyby_plus:
        description: 'å¯ç”¨ Adbyby Plus'
        required: false
        default: false
        type: boolean
      enable_original_modem:
        description: 'å¯ç”¨åŸç‰ˆ Modem'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_URL: https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/refs/heads/mt798x-mt799x-6.6-mtwifi/defconfig/mt7987_mt7992.config
  SOURCE_DIR: immortalwrt
  TZ: Asia/Shanghai

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      enable_adguardhome: ${{ steps.set-env.outputs.enable_adguardhome }}
      enable_openclash: ${{ steps.set-env.outputs.enable_openclash }}
      enable_nikki: ${{ steps.set-env.outputs.enable_nikki }}
      enable_upnp: ${{ steps.set-env.outputs.enable_upnp }}
      enable_vlmcsd: ${{ steps.set-env.outputs.enable_vlmcsd }}
      enable_mosdns: ${{ steps.set-env.outputs.enable_mosdns }}
      enable_dockerman: ${{ steps.set-env.outputs.enable_dockerman }}
      enable_qmodem_next: ${{ steps.set-env.outputs.enable_qmodem_next }}
      enable_qmodem: ${{ steps.set-env.outputs.enable_qmodem }}
      enable_mwan: ${{ steps.set-env.outputs.enable_mwan }}
      enable_homeproxy: ${{ steps.set-env.outputs.enable_homeproxy }}
      enable_adbyby_plus: ${{ steps.set-env.outputs.enable_adbyby_plus }}
      enable_original_modem: ${{ steps.set-env.outputs.enable_original_modem }}
    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        id: set-env
        run: |
          # ä» workflow_dispatch inputs è¯»å–é…ç½®
          echo "enable_adguardhome=${{ github.event.inputs.enable_adguardhome || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_openclash=${{ github.event.inputs.enable_openclash || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_nikki=${{ github.event.inputs.enable_nikki || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_upnp=${{ github.event.inputs.enable_upnp || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_vlmcsd=${{ github.event.inputs.enable_vlmcsd || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_mosdns=${{ github.event.inputs.enable_mosdns || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_dockerman=${{ github.event.inputs.enable_dockerman || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_qmodem_next=${{ github.event.inputs.enable_qmodem_next || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_qmodem=${{ github.event.inputs.enable_qmodem || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_mwan=${{ github.event.inputs.enable_mwan || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_homeproxy=${{ github.event.inputs.enable_homeproxy || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_adbyby_plus=${{ github.event.inputs.enable_adbyby_plus || 'false' }}" >> $GITHUB_OUTPUT
          echo "enable_original_modem=${{ github.event.inputs.enable_original_modem || 'false' }}" >> $GITHUB_OUTPUT

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ç¯å¢ƒå‡†å¤‡å’Œç¼“å­˜è®¾ç½®
        run: |
          echo "ğŸ”§ å‡†å¤‡æ„å»ºç¯å¢ƒ..."

          # åŸºç¡€æ¸…ç†
          sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
          docker system prune -f 2>/dev/null || true

          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "ğŸ’¾ å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"

          if [ "$AVAIL_GB" -lt 6 ]; then
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘6GB"
            exit 1
          fi

          # å®‰è£…å¿…è¦ä¾èµ–
          sudo apt-get update -qq
          sudo apt-get install -y build-essential git ccache python3 python3-pip \
            libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev rustc cargo \
            golang-go autoconf automake libtool patch make gcc g++

          # è®¾ç½® ccache
          echo "ğŸ“¦ è®¾ç½® ccache..."
          export PATH="/usr/lib/ccache:$PATH"
          ccache --version || true

      - name: æ¢å¤æ„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir
            ${{ env.SOURCE_DIR }}/build_dir
            ~/.ccache
          key: ${{ runner.os }}-build-${{ env.REPO_BRANCH }}-${{ hashFiles('feeds.conf.default', 'h5000m.extra.config') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.REPO_BRANCH }}-

      - name: æºç å’Œä¾èµ–å‡†å¤‡
        run: |
          # æ£€æŸ¥å¹¶å‡†å¤‡æºç 
          if [ ! -d "$SOURCE_DIR" ] || [ ! -d "$SOURCE_DIR/.git" ]; then
            echo "ğŸ“¥ å…‹éš†æºç ..."
            rm -rf "$SOURCE_DIR" 2>/dev/null || true
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          else
            echo "ğŸ”„ æ£€æŸ¥æºç æ›´æ–°..."
            cd $SOURCE_DIR
            CURRENT_BRANCH=$(git branch --show-current)
            if [ "$CURRENT_BRANCH" != "$REPO_BRANCH" ]; then
              echo "åˆ†æ”¯ä¸åŒï¼Œé‡æ–°å…‹éš†..."
              cd ..
              rm -rf "$SOURCE_DIR"
              git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
            else
              git fetch origin $REPO_BRANCH
              LOCAL_COMMIT=$(git rev-parse HEAD)
              REMOTE_COMMIT=$(git rev-parse FETCH_HEAD)
              if [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
                echo "æœ‰æ›´æ–°ï¼Œé‡ç½®åˆ°æœ€æ–°..."
                git reset --hard FETCH_HEAD
              else
                echo "æºç å·²æ˜¯æœ€æ–°"
              fi
            fi
            cd ..
          fi

          # è®¾ç½® feeds
          cd $SOURCE_DIR
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          fi

          # feeds.conf.default å’Œ feeds ç›®å½•/ç´¢å¼•å½»åº•åŒæ­¥ï¼Œå½»åº•é¿å… nikki æŠ¥é”™
          rm -rf feeds/nikki feeds/nikki.* feeds/nikki* feeds/nikki.index 2>/dev/null || true

          # åŠ¨æ€ç®¡ç† feeds.conf.default
          if [ "${{ steps.set-env.outputs.enable_nikki }}" = "true" ]; then
            :
          else
            sed -i '/src-git nikki/d' feeds.conf.default
          fi

          # QModem feed
          if [ "${{ steps.set-env.outputs.enable_qmodem_next }}" = "true" ] || [ "${{ steps.set-env.outputs.enable_qmodem }}" = "true" ]; then
            :
          else
            sed -i '/qmodem/d' feeds.conf.default
          fi

          # Adbyby Plus feed
          if [ "${{ steps.set-env.outputs.enable_adbyby_plus }}" = "true" ]; then
            if ! grep -q "coolsnowwolf_luci" feeds.conf.default; then
              echo 'src-git coolsnowwolf_luci https://github.com/coolsnowwolf/luci.git;master' >> feeds.conf.default
            fi
          else
            sed -i '/coolsnowwolf_luci/d' feeds.conf.default
          fi

          # feeds update/install
          echo "ğŸ”„ æ›´æ–° feeds..."
          ./scripts/feeds update -a -j $(nproc)
          ./scripts/feeds install -a -f -j $(nproc)

      - name: ä¿®å¤ä¾èµ–å’Œè¡¥ä¸
        run: |
          cd $SOURCE_DIR
          echo "ğŸ”§ åº”ç”¨è¡¥ä¸å’Œä¿®å¤ä¾èµ–..."
          
          # â­ ä¿®å¤ QMI WWAN é©±åŠ¨ Linux 6.6 å…¼å®¹æ€§ (æ‰€æœ‰å‚å•†é©±åŠ¨)
          fix_qmi_driver() {
            local SOURCE_FILE="$1"
            if [ -f "$SOURCE_FILE" ]; then
              echo "ğŸ”§ ä¿®å¤é©±åŠ¨: $SOURCE_FILE"
              
              # ä¿®å¤ u64_stats API å˜æ›´ (Linux 6.x ç§»é™¤äº† _irq åç¼€)
              sed -i 's/u64_stats_fetch_begin_irq/u64_stats_fetch_begin/g' "$SOURCE_FILE"
              sed -i 's/u64_stats_fetch_retry_irq/u64_stats_fetch_retry/g' "$SOURCE_FILE"
              
              # ä¿®å¤ dev_addr åªè¯»é—®é¢˜ (Linux 5.15+ dev_addr å˜ä¸º const)
              # æ–¹æ³•1: ä½¿ç”¨ eth_hw_addr_set (æ¨è)
              if grep -q 'memcpy.*qmap_net->dev_addr.*real_dev->dev_addr' "$SOURCE_FILE"; then
                sed -i 's/memcpy[[:space:]]*(qmap_net->dev_addr,[[:space:]]*real_dev->dev_addr,[[:space:]]*ETH_ALEN);/eth_hw_addr_set(qmap_net, real_dev->dev_addr);/g' "$SOURCE_FILE"
              fi
              # æ–¹æ³•2: å¤„ç†å…¶ä»–å¯èƒ½çš„ memcpy åˆ° dev_addr çš„æƒ…å†µ
              if grep -q 'memcpy.*->dev_addr' "$SOURCE_FILE"; then
                # ä½¿ç”¨ dev_addr_set ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                sed -i 's/memcpy[[:space:]]*(\([^,]*\)->dev_addr,[[:space:]]*\([^,]*\),[[:space:]]*ETH_ALEN);/dev_addr_set(\1, \2);/g' "$SOURCE_FILE" 2>/dev/null || true
              fi
              
              echo "âœ… é©±åŠ¨ä¿®å¤å®Œæˆ: $SOURCE_FILE"
            fi
          }
          
          # ä¿®å¤ Fibocom QMI WWAN é©±åŠ¨
          fix_qmi_driver "package/mtk/applications/5g-modem/fibocom_QMI_WWAN/qmi_wwan_f.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/fibocom_QMI_WWAN/src/qmi_wwan_f.c"
          
          # ä¿®å¤ Quectel QMI WWAN é©±åŠ¨ (å¦‚æœå­˜åœ¨)
          fix_qmi_driver "package/mtk/applications/5g-modem/quectel_QMI_WWAN/qmi_wwan_q.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/quectel_QMI_WWAN/src/qmi_wwan_q.c"
          
          # ä¿®å¤ Simcom QMI WWAN é©±åŠ¨ (å¦‚æœå­˜åœ¨)
          fix_qmi_driver "package/mtk/applications/5g-modem/simcom_QMI_WWAN/qmi_wwan_s.c"
          fix_qmi_driver "package/mtk/applications/5g-modem/simcom_QMI_WWAN/src/qmi_wwan_s.c"
          
          # ä¿®å¤ feeds ä¸­çš„ QModem é©±åŠ¨ (å¦‚æœå­˜åœ¨)
          for driver_file in $(find feeds/qmodem -name "*.c" -type f 2>/dev/null | xargs grep -l "u64_stats_fetch_begin_irq\|memcpy.*dev_addr" 2>/dev/null || true); do
            fix_qmi_driver "$driver_file"
          done
          
          # ä¸‹è½½é¢å¤–åŒ…
          if [ "${{ steps.set-env.outputs.enable_adguardhome }}" = "true" ]; then
            [ ! -d "package/luci-app-adguardhome" ] && \
              git clone --depth=1 https://github.com/kongfl888/luci-app-adguardhome.git package/luci-app-adguardhome
            
            AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
            if [ -f "$AGH_LUCI_SCRIPT" ]; then
              sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
            fi
            
            AGH_LUCI_INIT="package/luci-app-adguardhome/root/etc/init.d/AdGuardHome"
            if [ -f "$AGH_LUCI_INIT" ]; then
              sed -i '/^#!/a\
            [ -f /usr/bin/AdGuardHome ] && rm -f /usr/bin/AdGuardHome && mkdir -p /usr/bin/AdGuardHome' "$AGH_LUCI_INIT" || true
            fi
          fi

          # MosDNS å®‰è£…æ­¥éª¤
          if [ "${{ steps.set-env.outputs.enable_mosdns }}" = "true" ]; then
            if [ ! -d "feeds/packages/lang/golang" ] || [ ! -f "feeds/packages/lang/golang/Makefile" ]; then
              rm -rf feeds/packages/lang/golang
              git clone https://github.com/sbwml/packages_lang_golang -b 24.x feeds/packages/lang/golang
            fi
            rm -rf feeds/packages/net/v2ray-geodata
            if [ ! -d "package/mosdns" ]; then
              git clone https://github.com/sbwml/luci-app-mosdns -b v5 package/mosdns
            fi
            if [ ! -d "package/v2ray-geodata" ]; then
              git clone https://github.com/sbwml/v2ray-geodata package/v2ray-geodata
            fi
          fi
          
          rm -rf package/feeds/packages/{exim,onionshare-cli,python-zope-event,python-zope-interface,python-gevent,python-twisted} 2>/dev/null || true

          rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true

          QMODEM_MK="package/feeds/qmodem/qmodem/Makefile"
          if [ -f "$QMODEM_MK" ]; then
            sed -i 's/DEPENDS:=.*+kmod-mhi-wwan/# &/g' "$QMODEM_MK" || true
          fi

          MT_HWIFI_MK="package/mtk/drivers/mt_hwifi/Makefile"
          if [ -f "$MT_HWIFI_MK" ]; then
            sed -i 's/+kmod-mt_wifi_osal//g' "$MT_HWIFI_MK" || true
          fi


      - name: é…ç½®æ„å»º
        run: |
          cd $SOURCE_DIR
          echo "âš™ï¸ é…ç½®æ„å»ºé€‰é¡¹..."

          # éªŒè¯äº’æ–¥é€‰é¡¹
          if [ "${{ steps.set-env.outputs.enable_qmodem_next }}" = "true" ] && [ "${{ steps.set-env.outputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨ QModem Next å’Œ QModemï¼"
            exit 1
          fi
          if [ "${{ steps.set-env.outputs.enable_original_modem }}" = "true" ] && [ "${{ steps.set-env.outputs.enable_qmodem_next }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨åŸç‰ˆ Modem å’Œ QModem Nextï¼"
            exit 1
          fi
          if [ "${{ steps.set-env.outputs.enable_original_modem }}" = "true" ] && [ "${{ steps.set-env.outputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨åŸç‰ˆ Modem å’Œ QModemï¼"
            exit 1
          fi

          # ä¸‹è½½åŸºç¡€é…ç½®
          curl -fsSL "$CONFIG_URL" -o base.config || {
            [ -f "defconfig/mt7987_mt7992.config" ] && cp defconfig/mt7987_mt7992.config base.config
          }

          cat base.config > .config

          # åº”ç”¨é¢å¤–é…ç½®
          if [ -f "$GITHUB_WORKSPACE/h5000m.extra.config" ]; then
            echo "ğŸ“„ åº”ç”¨é¢å¤–é…ç½®..."
            cat "$GITHUB_WORKSPACE/h5000m.extra.config" >> .config
          fi

          # æ ¹æ®è¾“å…¥åŠ¨æ€é…ç½®åŒ…ï¼ˆç®€åŒ–ï¼šåªå¯ç”¨é¡¶å±‚åŒ…ï¼Œä¾èµ–ç”± make defconfig è‡ªåŠ¨è§£æï¼‰
          disabled_pkgs=("luci-app-sms-tool-lite" "luci-app-3ginfo-lite")

          # è¯»å–ç¯å¢ƒå˜é‡åˆ°å…³è”æ•°ç»„
          declare -A pkg_enabled
          pkg_enabled["adguardhome"]="${{ steps.set-env.outputs.enable_adguardhome }}"
          pkg_enabled["openclash"]="${{ steps.set-env.outputs.enable_openclash }}"
          pkg_enabled["nikki"]="${{ steps.set-env.outputs.enable_nikki }}"
          pkg_enabled["upnp"]="${{ steps.set-env.outputs.enable_upnp }}"
          pkg_enabled["vlmcsd"]="${{ steps.set-env.outputs.enable_vlmcsd }}"
          pkg_enabled["mosdns"]="${{ steps.set-env.outputs.enable_mosdns }}"
          pkg_enabled["dockerman"]="${{ steps.set-env.outputs.enable_dockerman }}"
          pkg_enabled["mwan3"]="${{ steps.set-env.outputs.enable_mwan }}"
          pkg_enabled["homeproxy"]="${{ steps.set-env.outputs.enable_homeproxy }}"
          pkg_enabled["adbyby-plus"]="${{ steps.set-env.outputs.enable_adbyby_plus }}"

          for pkg in "${!pkg_enabled[@]}"; do
            if [ "${pkg_enabled[$pkg]}" = "true" ]; then
              echo "CONFIG_PACKAGE_luci-app-$pkg=y" >> .config
            else
              disabled_pkgs+=("luci-app-$pkg")
            fi
          done

          # åŸç‰ˆ Modem å¤„ç†ï¼ˆäº’æ–¥ï¼‰
          if [ "${{ steps.set-env.outputs.enable_original_modem }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-modem=y" >> .config
            echo "CONFIG_PACKAGE_modem=y" >> .config
          else
            disabled_pkgs+=("luci-app-modem" "modem")
          fi

          # QModem ç‰¹æ®Šå¤„ç†ï¼ˆäº’æ–¥ï¼‰
          if [ "${{ steps.set-env.outputs.enable_qmodem_next }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-qmodem-next=y" >> .config
          elif [ "${{ steps.set-env.outputs.enable_qmodem }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-qmodem=y" >> .config
            # QModem æ ¸å¿ƒ
            echo "CONFIG_PACKAGE_luci-compat=y" >> .config
            echo "CONFIG_PACKAGE_qmodem=y" >> .config
            # QModem é©±åŠ¨é€‰æ‹© - ä½¿ç”¨ Vendor é©±åŠ¨
            echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_vendor-qmi-wwan=y" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_generic-qmi-wwan is not set" >> .config
            # QModem IPv6 æ”¯æŒ
            echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_ndisc6=y" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_rdisc6 is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_no_ndisc_rdisc6 is not set" >> .config
            echo "CONFIG_PACKAGE_ndisc6=y" >> .config
            # QModem Quectel CM é€‰æ‹© - ä½¿ç”¨ Tom å®šåˆ¶ç‰ˆ
            echo "CONFIG_PACKAGE_luci-app-qmodem_USE_TOM_CUSTOMIZED_QUECTEL_CM=y" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_USING_QWRT_QUECTEL_CM_5G is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-qmodem_USING_NORMAL_QUECTEL_CM is not set" >> .config
            echo "CONFIG_PACKAGE_quectel-CM-5G-M=y" >> .config
            # QModem ä¾èµ–å·¥å…·
            echo "CONFIG_PACKAGE_sms-tool_q=y" >> .config
            echo "CONFIG_PACKAGE_ubus-at-daemon=y" >> .config
            echo "CONFIG_PACKAGE_tom_modem=y" >> .config
            # QModem Vendor QMI é©±åŠ¨
            echo "CONFIG_PACKAGE_kmod-qmi_wwan_q=y" >> .config
            echo "CONFIG_PACKAGE_kmod-qmi_wwan_f=y" >> .config
            echo "CONFIG_PACKAGE_kmod-qmi_wwan_s=y" >> .config
            # QModem MWAN (å¤šWANè´Ÿè½½å‡è¡¡)
            echo "CONFIG_PACKAGE_mwan3=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
            # HQOS æ”¯æŒ
            echo "CONFIG_PACKAGE_mtkhqos_util=y" >> .config
          else
            disabled_pkgs+=("luci-app-qmodem-next" "luci-app-qmodem")
          fi

          # è‡ªåŠ¨è§£æä¾èµ–ï¼ˆå…³é”®ï¼šmake defconfig ä¼šå¯ç”¨æ‰€æœ‰å¿…éœ€ä¾èµ–ï¼‰
          make defconfig

          # ç»Ÿä¸€ç¦ç”¨ä¸éœ€è¦çš„åŒ…
          all_disabled=("luci-app-wrtbwmon" "luci-app-rclone" "rclone" "rclone-ng" "rclone-webui-react" "${disabled_pkgs[@]}")
          for pkg in "${all_disabled[@]}"; do
            sed -i "/^CONFIG_PACKAGE_${pkg}=/d" .config
            echo "# CONFIG_PACKAGE_${pkg} is not set" >> .config
          done

          echo "âœ… é…ç½®å®Œæˆ"

      - name: é¢„ä¸‹è½½æ„å»ºä¾èµ–
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¥ é¢„ä¸‹è½½æ„å»ºä¾èµ–..."
          THREADS=$(nproc)
          if [ -z "$(ls -A dl 2>/dev/null)" ]; then
            make download -j$THREADS || echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œå°†åœ¨æ„å»ºæ—¶é‡è¯•"
          else
            echo "âœ… ä¾èµ–å·²ç¼“å­˜ï¼Œè·³è¿‡é¢„ä¸‹è½½"
          fi

      - name: é¢„æ„å»ºå·¥å…·é“¾
        run: |
          cd $SOURCE_DIR
          echo "ğŸ”§ é¢„æ„å»ºå·¥å…·é“¾..."
          THREADS=$(nproc)
          if [ ! -d "staging_dir" ] || [ -z "$(ls -A staging_dir 2>/dev/null)" ]; then
            make toolchain/install -j$THREADS || echo "âš ï¸ å·¥å…·é“¾æ„å»ºå¤±è´¥ï¼Œå°†åœ¨æ„å»ºæ—¶é‡è¯•"
          else
            echo "âœ… å·¥å…·é“¾å·²ç¼“å­˜ï¼Œè·³è¿‡é¢„æ„å»º"
          fi

      - name: æ‰“åŒ…æºç 
        run: |
          echo "ğŸ“¦ æ‰“åŒ…æºç å’Œé…ç½®..."
          tar --exclude="$SOURCE_DIR/build_dir" --exclude="$SOURCE_DIR/tmp" -czf source.tar.gz $SOURCE_DIR $GITHUB_WORKSPACE/h5000m.extra.config $GITHUB_WORKSPACE/feeds.conf.default 2>/dev/null || true

      - name: ä¸Šä¼ æºç 
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ github.run_number }}
          path: source.tar.gz
          retention-days: 1

  build:
    needs: prepare
    runs-on: ubuntu-22.04
    steps:
      - name: ä¸‹è½½æºç 
        uses: actions/download-artifact@v4
        with:
          name: source-${{ github.run_number }}

      - name: è§£å‹æºç 
        run: |
          echo "ğŸ“¦ è§£å‹æºç ..."
          tar -xzf source.tar.gz
          echo "âœ… æºç è§£å‹å®Œæˆ"

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y build-essential git ccache python3 python3-pip \
            libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev \
            autoconf automake libtool patch make gcc g++ gawk gettext unzip file wget
          
          # è®¾ç½® ccache
          export PATH="/usr/lib/ccache:$PATH"
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          echo "âœ… ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆ"

      - name: æ·±åº¦æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          echo "ğŸ§¹ æ‰§è¡Œæ·±åº¦æ¸…ç†ä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´..."
          
          # åˆ é™¤ Docker èµ„æº
          docker rmi $(docker images -q) 2>/dev/null || true
          docker system prune -f 2>/dev/null || true
          
          # åˆ é™¤å¤§å‹ç»„ä»¶
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php \
            /usr/local/share/boost /usr/share/swift /opt/hostedtoolcache /usr/local/.ghcup \
            /usr/local/graalvm /imagegeneration /usr/local/share /opt /var/cache/apt/archives/* \
            /etc/apt/sources.list.d/* 2>/dev/null || true
          
          # å¸è½½ä¸éœ€è¦çš„è½¯ä»¶åŒ…
          sudo apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* 2>/dev/null || true
          
          # æ¸…ç†åŒ…ç®¡ç†å™¨å’Œä¸´æ—¶æ–‡ä»¶
          sudo apt-get autoremove --purge -y && sudo apt-get clean && sudo apt-get autoclean
          sudo rm -rf /tmp/* /var/tmp/* /var/log/* ~/.cache/* 2>/dev/null || true
          
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "âœ… æ¸…ç†åå¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd $SOURCE_DIR
          THREADS=$(nproc)  # åŠ¨æ€ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ ¸å¿ƒï¼Œæé«˜æ•ˆç‡
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS} çº¿ç¨‹)..."
          echo "ğŸ“Š CCache ç»Ÿè®¡ (å¼€å§‹):"
          ccache -s || true
          
          START_TIME=$(date +%s)
          
          # ä¼˜åŒ–ï¼šé¢„æ£€æŸ¥ä¾èµ–ï¼Œé¿å…é‡å¤ä¸‹è½½
          if [ -z "$(ls -A dl 2>/dev/null)" ] || ! make download -j$THREADS; then
            echo "âš ï¸ ä¸‹è½½ä¾èµ–..."
            find dl -size -1024c -delete 2>/dev/null || true
            make download -j$THREADS
          else
            echo "âœ… ä¾èµ–å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½"
          fi
          
          # ç¼–è¯‘ï¼ˆä½¿ç”¨ V=s ä»…åœ¨å¤±è´¥æ—¶æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼Œæé«˜æ•ˆç‡ï¼‰
          if make -j$THREADS IGNORE_ERRORS=n; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "âœ… ç¼–è¯‘æˆåŠŸ (è€—æ—¶: ${DURATION}s)"
            echo "ğŸ“Š CCache ç»Ÿè®¡ (ç»“æŸ):"
            ccache -s || true
          else
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è°ƒè¯•..."
            make -j1 V=s || {
              echo "âŒ ç¼–è¯‘å¤±è´¥"
              exit 1
            }
          fi

      - name: æ‰“åŒ…äº§ç‰©
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¦ æ‰“åŒ…äº§ç‰©..."
          mkdir -p ../artifacts
          find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} ../artifacts/ \;
          cd ..
          tar -czf artifacts.tar.gz artifacts/

      - name: éªŒè¯äº§ç‰©
        run: |
          echo "ğŸ” éªŒè¯äº§ç‰©..."
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          else
            echo "âœ… äº§ç‰©éªŒè¯é€šè¿‡"
            ls -lh artifacts/
          fi

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ github.run_number }}
          path: artifacts.tar.gz
          retention-days: 30

  release:
    needs: [prepare, build]
    runs-on: ubuntu-22.04
    if: success()
    steps:
      - name: ä¸‹è½½äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: artifacts-${{ github.run_number }}

      - name: è§£å‹äº§ç‰©
        run: |
          echo "ğŸ“¦ è§£å‹äº§ç‰©..."
          tar -xzf artifacts.tar.gz
          echo "âœ… äº§ç‰©è§£å‹å®Œæˆ"

      - name: æ”¶é›†å’Œä¸Šä¼ äº§ç‰©
        run: |
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          fi

          # ç”Ÿæˆæ¸…å•
          cat > artifacts/MANIFEST.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ImmortalWrt H5000M å›ºä»¶æ„å»ºä¿¡æ¯             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“… æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}
          ğŸ·ï¸  Build #: ${{ github.run_number }}

          âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:
          â€¢ AdGuardHome:   ${{ needs.prepare.outputs.enable_adguardhome }}
          â€¢ OpenClash:     ${{ needs.prepare.outputs.enable_openclash }}
          â€¢ Nikki:        ${{ needs.prepare.outputs.enable_nikki }}
          â€¢ UPnP:          ${{ needs.prepare.outputs.enable_upnp }}
          â€¢ VLMCSd:        ${{ needs.prepare.outputs.enable_vlmcsd }}
          â€¢ MosDNS:        ${{ needs.prepare.outputs.enable_mosdns }}
          â€¢ DockerMan:     ${{ needs.prepare.outputs.enable_dockerman }}
          â€¢ QModem Next:   ${{ needs.prepare.outputs.enable_qmodem_next }}
          â€¢ QModem:        ${{ needs.prepare.outputs.enable_qmodem }}
          â€¢ MWAN:          ${{ needs.prepare.outputs.enable_mwan }}
          â€¢ HomeProxy:     ${{ needs.prepare.outputs.enable_homeproxy }}
          â€¢ Adbyby Plus:   ${{ needs.prepare.outputs.enable_adbyby_plus }}
          â€¢ åŸç‰ˆ Modem:    ${{ needs.prepare.outputs.enable_original_modem }}

          ğŸ“¦ äº§ç‰©æ–‡ä»¶:
          EOF

          cd artifacts
          ls -lh | grep -v "^total" | awk '{print "  â€¢ " $9 " (" $5 ")"}' >> MANIFEST.txt

          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ"

      - name: ä¸Šä¼ æ„å»ºç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-H5000M-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt H5000M #${{ github.run_number }}
          body: |
            ğŸ‰ **ImmortalWrt H5000M å›ºä»¶å·²æ„å»ºå®Œæˆ**

            ğŸ“… æ—¶é—´: ${{ github.event.repository.updated_at }}
            ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}

            **âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:**
            - AdGuardHome: ${{ needs.prepare.outputs.enable_adguardhome }}
            - OpenClash: ${{ needs.prepare.outputs.enable_openclash }}
            - Nikki: ${{ needs.prepare.outputs.enable_nikki }}
            - UPnP: ${{ needs.prepare.outputs.enable_upnp }}
            - VLMCSd: ${{ needs.prepare.outputs.enable_vlmcsd }}
            - MosDNS: ${{ needs.prepare.outputs.enable_mosdns }}
            - DockerMan: ${{ needs.prepare.outputs.enable_dockerman }}
            - MWAN: ${{ needs.prepare.outputs.enable_mwan }}
            - HomeProxy: ${{ needs.prepare.outputs.enable_homeproxy }}
            - Adbyby Plus: ${{ needs.prepare.outputs.enable_adbyby_plus }}
            - åŸç‰ˆ Modem: ${{ needs.prepare.outputs.enable_original_modem }}

            ğŸ’¾ ä¸‹è½½äº§ç‰©: è§ä¸‹æ–¹ Artifacts
            ğŸ“‹ è¯¦ç»†ä¿¡æ¯: è§ MANIFEST.txt
          prerelease: true
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}