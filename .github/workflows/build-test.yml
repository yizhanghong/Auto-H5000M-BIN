# æ„å»º ImmortalWrt H5000M å›ºä»¶çš„ GitHub Actions å·¥ä½œæµ
name: Build ImmortalWrt H5000M

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      enable_adguardhome:
        description: 'å¯ç”¨ AdGuardHome'
        required: false
        default: 'false'
        type: boolean
      enable_homeproxy:
        description: 'å¯ç”¨ HomeProxy'
        required: false
        default: 'false'
        type: boolean
      enable_openclash:
        description: 'å¯ç”¨ OpenClash'
        required: false
        default: 'false'
        type: boolean
      enable_mihomo:
        description: 'å¯ç”¨ Mihomo'
        required: false
        default: 'true'
        type: boolean
      enable_upnp:
        description: 'å¯ç”¨ UPnP'
        required: false
        default: 'true'
        type: boolean
      enable_vlmcsd:
        description: 'å¯ç”¨ VLMCSd'
        required: false
        default: 'true'
        type: boolean
      enable_smartdns:
        description: 'å¯ç”¨ SmartDNS'
        required: false
        default: 'true'
        type: boolean
      enable_mosdns:
        description: 'å¯ç”¨ MosDNS'
        required: false
        default: 'false'
        type: boolean
      enable_dockerman:
        description: 'å¯ç”¨ DockerMan'
        required: false
        default: 'false'
        type: boolean
      enable_qmodem_next:
        description: 'å¯ç”¨ QModem Next (æ–°ç‰ˆJSå‰ç«¯)'
        required: false
        default: 'true'
        type: boolean
      enable_qmodem:
        description: 'å¯ç”¨ QModem (æ—§ç‰ˆ)'
        required: false
        default: 'false'
        type: boolean
      enable_mwan:
        description: 'å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)'
        required: false
        default: 'true'
        type: boolean

# æƒé™ï¼šå…è®¸å†™å…¥å†…å®¹ï¼ˆç”¨äºåˆ›å»º releaseï¼‰
permissions:
  contents: write

# ç¯å¢ƒå˜é‡
env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10  # ImmortalWrt æºç ä»“åº“ URL
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi  # æºç åˆ†æ”¯
  CONFIG_FILE: mt7987_mt7992.config  # é»˜è®¤é…ç½®æ–‡ä»¶
  TZ: Asia/Shanghai  # æ—¶åŒº
  SOURCE_DIR: immortalwrt  # æºç ç›®å½•

# ä½œä¸šå®šä¹‰
jobs:
  build:  # æ„å»ºä½œä¸š
    runs-on: ubuntu-22.04  # è¿è¡Œç¯å¢ƒ
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: ç¼“å­˜ç¼–è¯‘å™¨ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
          key: ${{ runner.os }}-ccache-${{ env.CONFIG_FILE }}-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ env.CONFIG_FILE }}-
      - name: æ¢å¤æ„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
            ${{ env.SOURCE_DIR }}/build_dir/host
            ${{ env.SOURCE_DIR }}/build_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-
      - name: å…‹éš†æºç å¹¶è®¾ç½® feeds
        run: |
          if [ -d "$SOURCE_DIR/.git" ]; then
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fd
          else
            rm -rf $SOURCE_DIR
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
            cd $SOURCE_DIR
          fi

          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
            echo "ä½¿ç”¨è‡ªå®šä¹‰ feeds.conf.default"
          else
            echo "ä½¿ç”¨é»˜è®¤ feeds.conf.default"
          fi

          ./scripts/feeds update -a || echo "è­¦å‘Š: éƒ¨åˆ† feeds æ›´æ–°å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œ..."
          ./scripts/feeds install -a -f || echo "è­¦å‘Š: éƒ¨åˆ† feeds å®‰è£…å¤±è´¥ï¼Œç»§ç»­è¿›è¡Œ..."

          # å¦‚æœå¯ç”¨ AdGuardHomeï¼Œåˆ™å…‹éš†åŒ…
          if [ "${{ inputs.enable_adguardhome }}" = "true" ]; then
            [ ! -d "package/luci-app-adguardhome" ] && \
              git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome || true
          fi

          AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
          if [ -f "$AGH_LUCI_SCRIPT" ]; then
            sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
          fi

          rm -rf package/feeds/packages/exim package/feeds/packages/onionshare-cli package/feeds/packages/python-zope-event package/feeds/packages/python-zope-interface 2>/dev/null || true
      - name: é…ç½®æ„å»º
        run: |
          cd $SOURCE_DIR
          cp -f defconfig/$CONFIG_FILE .config

          # å†²çªæ£€æµ‹
          echo "ğŸ” æ£€æŸ¥é€‰é¡¹å†²çª..."
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] && [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨ QModem Next å’Œ QModem æ—§ç‰ˆï¼"
            exit 1
          fi
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ]; then
            echo "âœ… é€‰æ‹© QModem Next (æ–°ç‰ˆJSå‰ç«¯)ï¼Œå°†ç¦ç”¨ luci-compat ä¾èµ–"
          fi
          if [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "âœ… é€‰æ‹© QModem (æ—§ç‰ˆ)ï¼Œå°†å¯ç”¨ luci-compat ä¾èµ–"
          fi

          if [ -f "$GITHUB_WORKSPACE/h5000m.extra.config" ]; then
            cat "$GITHUB_WORKSPACE/h5000m.extra.config" >> .config
            echo "è¿½åŠ äº†æ¥è‡ª h5000m.extra.config çš„é¢å¤–é…ç½®"
          else
            echo "æœªæ‰¾åˆ°é¢å¤–é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤ .config"
          fi

          # æ ¹æ® inputs å¯ç”¨å¯é€‰æ’ä»¶
          if [ "${{ inputs.enable_adguardhome }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
            echo "CONFIG_PACKAGE_adguardhome=y" >> .config
            echo "å¯ç”¨ AdGuardHome"
          fi
          if [ "${{ inputs.enable_homeproxy }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-homeproxy=y" >> .config
            echo "å¯ç”¨ HomeProxy"
          fi
          if [ "${{ inputs.enable_openclash }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
            echo "CONFIG_PACKAGE_ruby=y" >> .config
            echo "CONFIG_PACKAGE_ruby-yaml=y" >> .config
            echo "CONFIG_PACKAGE_libyaml=y" >> .config
            echo "å¯ç”¨ OpenClash"
          fi
          if [ "${{ inputs.enable_mihomo }}" = "true" ]; then
            echo "CONFIG_PACKAGE_nikki=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_mihomo=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-mihomo=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-mihomo-zh-cn=y" >> .config
            echo "å¯ç”¨ Mihomo"
          fi
          if [ "${{ inputs.enable_upnp }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
            echo "å¯ç”¨ UPnP"
          fi
          if [ "${{ inputs.enable_vlmcsd }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
            echo "CONFIG_PACKAGE_vlmcsd=y" >> .config
            echo "å¯ç”¨ VLMCSd"
          fi
          if [ "${{ inputs.enable_smartdns }}" = "true" ]; then
            echo "CONFIG_PACKAGE_smartdns=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-smartdns-zh-cn=y" >> .config
            echo "å¯ç”¨ SmartDNS"
          fi
          if [ "${{ inputs.enable_mosdns }}" = "true" ]; then
            echo "CONFIG_PACKAGE_mosdns=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-mosdns=y" >> .config
            echo "å¯ç”¨ MosDNS"
          fi
          if [ "${{ inputs.enable_dockerman }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-dockerman=y" >> .config
            echo "CONFIG_PACKAGE_docker=y" >> .config
            echo "CONFIG_PACKAGE_docker-compose=y" >> .config
            echo "CONFIG_PACKAGE_kmod-veth=y" >> .config
            echo "CONFIG_PACKAGE_kmod-dm=y" >> .config
            echo "CONFIG_PACKAGE_kmod-br-netfilter=y" >> .config
            echo "CONFIG_PACKAGE_kmod-ipt-nat=y" >> .config
            echo "å¯ç”¨ DockerMan"
          fi
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-qmodem-next=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_vendor-qmi-wwan=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_ndisc6=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-qmodem_USE_TOM_CUSTOMIZED_QUECTEL_CM=y" >> .config
            echo "å¯ç”¨ QModem Next (æ–°ç‰ˆJSå‰ç«¯)"
          fi
          if [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-qmodem=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_vendor-qmi-wwan=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_ndisc6=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-qmodem_USE_TOM_CUSTOMIZED_QUECTEL_CM=y" >> .config
            echo "å¯ç”¨ QModem (æ—§ç‰ˆ)"
          fi
          if [ "${{ inputs.enable_mwan }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci-app-qmodem-mwan=y" >> .config
            echo "CONFIG_PACKAGE_mwan3=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
            echo "å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)"
          fi

          make defconfig || true
      - name: éªŒè¯æ„å»ºé…ç½®
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¦ å…³é”®åŒ…é…ç½®çŠ¶æ€:"
          grep -E "CONFIG_PACKAGE_qmodem=" .config || echo "QModem æ ¸å¿ƒåŒ…æœªæ‰¾åˆ°"
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] || [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_(luci-app-qmodem|luci-app-qmodem-next)=" .config || echo "QModem UI åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_adguardhome }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_(luci-app-adguardhome|adguardhome)=" .config || echo "AdGuardHome åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_mihomo }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_(mihomo|luci-app-mihomo)=" .config || echo "Mihomo åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_upnp }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_luci-app-upnp=" .config || echo "UPnP åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_vlmcsd }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_(luci-app-vlmcsd|vlmcsd)=" .config || echo "VLMCSd åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_smartdns }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_(smartdns|luci-app-smartdns)=" .config || echo "SmartDNS åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_mosdns }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_(mosdns|luci-app-mosdns)=" .config || echo "MosDNS åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_dockerman }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_(luci-app-dockerman|docker)=" .config || echo "DockerMan åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_luci-app-qmodem-next=" .config || echo "QModem Next åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_luci-app-qmodem=" .config || echo "QModem åŒ…æœªæ‰¾åˆ°"
          fi
          if [ "${{ inputs.enable_mwan }}" = "true" ]; then
            grep -E "CONFIG_PACKAGE_(luci-app-qmodem-mwan|mwan3)=" .config || echo "MWAN åŒ…æœªæ‰¾åˆ°"
          fi
      - name: ä¸‹è½½å¹¶ç¼–è¯‘
        run: |
          cd $SOURCE_DIR
          THREADS=$(($(nproc) + 1))
          export PATH="/usr/lib/ccache:$PATH"
          for i in 1 2 3; do make download -j16 && break; find dl -size -1024c -delete 2>/dev/null; sleep 3; done
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS} çº¿ç¨‹)..."
          make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || make -j1 V=s || true
      - name: å‡†å¤‡å¹¶ä¸Šä¼ äº§ç‰©
        run: |
          mkdir -p artifacts
          find $SOURCE_DIR/bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} artifacts/ \; || true
          if [ "$(ls -A artifacts/ 2>/dev/null)" ]; then
            ls -lh artifacts/
          else
            echo "æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ï¼Œè·³è¿‡ä¸Šä¼ "
            exit 1
          fi
      - name: ä¸Šä¼ åˆ° Actions
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImmortalWrt-MT7987-${{ github.run_number }}
          path: artifacts/
          retention-days: 30
      - name: åˆ›å»ºé¢„å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        if: success() && hashFiles('artifacts/*') != ''
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt MT7987/MT7992 #${{ github.run_number }}
          body: |
            ğŸ”§ è‡ªåŠ¨æ„å»º ImmortalWrt MT7987/MT7992 å›ºä»¶
            ğŸ“… æ—¶é—´: ${{ github.event.repository.updated_at }}
            ğŸŒ¿ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          prerelease: true
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: ä¿å­˜æ„å»ºç¼“å­˜
        uses: actions/cache@v4
        if: always()
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
            ${{ env.SOURCE_DIR }}/build_dir/host
            ${{ env.SOURCE_DIR }}/build_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ hashFiles('**/feeds.conf.default') }}-${{ github.run_id }}
