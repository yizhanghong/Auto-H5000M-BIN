name: Build ImmortalWrt H5000M

on:
  schedule:
    - cron: '0 16 * * 0'  # æ¯å‘¨æ—¥ UTC 16:00 (åŒ—äº¬æ—¶é—´å‘¨ä¸€ 0:00)
  workflow_dispatch:
    inputs:
      clean-cache:
        description: 'æ¸…ç†æž„å»ºç¼“å­˜ï¼ˆä»…åœ¨é‡åˆ°é—®é¢˜æ—¶å¯ç”¨ï¼‰'
        required: false
        default: 'false'
      skip-feeds-update:
        description: 'è·³è¿‡feedsæ›´æ–°ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_FILE: h5000m.config
  TZ: Asia/Shanghai
  SOURCE_DIR: immortalwrt

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: åˆå§‹åŒ–çŽ¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "========== ç£ç›˜ç©ºé—´æ¸…ç† =========="
          df -h
          
          # æ¸…ç†Dockeré•œåƒ
          docker rmi $(docker images -q) 2>/dev/null || true
          
          # åˆ é™¤ä¸éœ€è¦çš„å¤§åž‹ç»„ä»¶
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php
          
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          sudo apt-get update -qq
          sudo apt-get install -qq -y build-essential ccache clang cmake curl \
            gcc-multilib g++-multilib git libncurses5-dev libssl-dev \
            python3 python3-pip python3-setuptools rsync unzip wget
          
          sudo apt-get autoremove -qq --purge
          sudo apt-get clean -qq
          
          # è®¾ç½®æ—¶åŒº
          sudo timedatectl set-timezone "$TZ"
          
          echo "ç³»ç»Ÿä¿¡æ¯: $(nproc) æ ¸å¿ƒ, $(free -g | awk '/Mem:/{print $2}')GB å†…å­˜"
          df -h /home/runner

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: workspace

      # ==================== ç¼“å­˜é…ç½® ====================
      - name: è®¾ç½®CCache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-ccache-${{ hashFiles('h5000m.config') }}
          max-size: 8G
          save: ${{ github.event.inputs.clean-cache != 'true' }}

      - name: æ¢å¤æž„å»ºç¼“å­˜
        id: restore-cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/feeds
            ${{ env.SOURCE_DIR }}/staging_dir
            ${{ env.SOURCE_DIR }}/build_dir
          key: ${{ runner.os }}-immortalwrt-${{ hashFiles('h5000m.config') }}
          restore-keys: |
            ${{ runner.os }}-immortalwrt-

      - name: å…‹éš†æºç 
        run: |
          if [[ -d "$SOURCE_DIR/.git" && "${{ steps.restore-cache.outputs.cache-hit }}" == 'true' ]]; then
            echo "âœ… ä½¿ç”¨ç¼“å­˜çš„æºç ç›®å½•"
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
          else
            echo "ðŸ”„ é‡æ–°å…‹éš†æºç "
            rm -rf $SOURCE_DIR
            git clone -b $REPO_BRANCH --depth=1 $REPO_URL $SOURCE_DIR
            cd $SOURCE_DIR
          fi
          
          # ä¼˜åŒ–CCacheé…ç½®
          ccache --set-config=compression=true
          ccache --set-config=max_size=8G

      - name: ä¿®å¤5Gè°ƒåˆ¶è§£è°ƒå™¨å†²çª
        run: |
          cd $SOURCE_DIR
          echo "ðŸ”§ ä¿®å¤5Gè°ƒåˆ¶è§£è°ƒå™¨åŒ…å†²çªé—®é¢˜..."
          
          # å…³é”®ä¿®å¤ï¼šé‡å‘½åå†²çªç›®å½•
          if [ -d "package/mtk/applications/5g-modem" ]; then
            echo "ç§»é™¤å†²çªç›®å½•ä»¥é¿å…ç¼–è¯‘é”™è¯¯..."
            rm -rf "package/mtk/applications/5g-modem" 2>/dev/null || true"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°å†²çªç›®å½•ï¼Œå¯èƒ½å·²è¢«ä¿®å¤"
          fi
          
          # ç¡®ä¿qmodem feedå­˜åœ¨
          if [ ! -d "feeds/qmodem" ]; then
            echo "æ·»åŠ qmodem feed..."
            echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
          fi

      - name: æ›´æ–°å’Œå®‰è£…Feeds
        run: |
          cd $SOURCE_DIR
          
          # æ ¹æ®è¾“å…¥å‚æ•°å†³å®šæ˜¯å¦è·³è¿‡feedsæ›´æ–°
          if [[ "${{ github.event.inputs.skip-feeds-update }}" == 'true' && -d feeds ]]; then
            echo "â­ï¸ è·³è¿‡feedsæ›´æ–°ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰"
          else
            echo "ðŸ”„ æ›´æ–°feeds..."
            ./scripts/feeds update -a
            
            echo "ðŸ“¦ å®‰è£…feeds..."
            ./scripts/feeds install -a > /dev/null 2>&1 || ./scripts/feeds install -a
          fi
          
          # å…‹éš†é¢å¤–çš„luci-app-adguardhome
          if [ ! -d "package/luci-app-adguardhome" ]; then
            git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome
          fi

      - name: ä¿®å¤ä¾èµ–é—®é¢˜
        run: |
          cd $SOURCE_DIR
          echo "ðŸ”§ ä¿®å¤å·²çŸ¥ä¾èµ–é—®é¢˜..."
          
          # ç§»é™¤æœ‰é—®é¢˜çš„åŒ…
          rm -rf package/feeds/packages/exim 2>/dev/null || true
          rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true
          
          # ä¿®å¤QModemä¾èµ–
          QMODEM_MK="package/feeds/qmodem/qmodem/Makefile"
          if [ -f "$QMODEM_MK" ]; then
            sed -i 's/+kmod-mhi-wwan/# +kmod-mhi-wwan/g' "$QMODEM_MK" || true
            echo "âœ… QModemä¾èµ–å·²ä¿®å¤"
          fi

      - name: åº”ç”¨é…ç½®
        run: |
          cd $SOURCE_DIR
          
          # ä½¿ç”¨ä¿®å¤åŽçš„é…ç½®æ–‡ä»¶
          cp $GITHUB_WORKSPACE/workspace/h5000m.config .config
          # ç¡®ä¿CCacheå¯ç”¨
          if ! grep -q "CONFIG_CCACHE=y" .config; then
            echo "CONFIG_CCACHE=y" >> .config
          fi
          # ç”Ÿæˆå®Œæ•´é…ç½®
          make defconfig
          echo "ðŸ“‹ é…ç½®éªŒè¯:"
          echo "å†²çªåŒ…çŠ¶æ€:"
          grep -E "CONFIG_PACKAGE.*QMI_WWAN" .config || echo "âœ… æ— å†²çªåŒ…é…ç½®"
          echo ""
          echo "ä¸»è¦åŠŸèƒ½åŒ…:"
          grep -E "CONFIG_PACKAGE_(qmodem|luci-app-qmodem|adguardhome|mihomo)=" .config || true

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        run: |
          cd $SOURCE_DIR
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "ðŸ“Š CCacheçŠ¶æ€:"
          ccache -s
          
          echo "â¬‡ï¸ ä¸‹è½½è½¯ä»¶åŒ…..."
          # ä½¿ç”¨å¤šçº¿ç¨‹ä¸‹è½½ï¼Œå¤±è´¥æ—¶é‡è¯•
          for i in 1 2 3; do
            make download -j$(nproc) && break
            echo "ä¸‹è½½å°è¯• $i å¤±è´¥ï¼Œé‡è¯•..."
            find dl -size -1024c -delete 2>/dev/null
            sleep 5
          done

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd $SOURCE_DIR
          THREADS=$(($(nproc) + 1))
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS}çº¿ç¨‹)..."
          echo "=========================================="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å†²çªåŒ…è¢«é”™è¯¯å¯ç”¨
          CONFLICT_PKGS=$(grep -E "CONFIG_PACKAGE_(fibocom|quectel|simcom)_QMI_WWAN=y" .config 2>/dev/null || true)
          if [ -n "$CONFLICT_PKGS" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°å†²çªåŒ…é…ç½®"
            echo "$CONFLICT_PKGS"
            echo "å°è¯•ä¿®å¤..."
            make defconfig
          fi
          
          # ä½¿ç”¨CCacheåŠ é€Ÿç¼–è¯‘
          make -j$THREADS IGNORE_ERRORS=m 2>&1 | tee build.log || \
            (echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..." && make -j1 V=s 2>&1 | tee build_fallback.log)
          
          echo "=========================================="
          echo "ðŸ“Š ç¼–è¯‘å®Œæˆï¼ŒCCacheç»Ÿè®¡:"
          ccache -s
          
          # æ£€æŸ¥ç¼–è¯‘é”™è¯¯
          if [ -f "build.log" ]; then
            echo "ðŸ” é”™è¯¯æ‘˜è¦:"
            grep -i "error:" build.log | head -5 || echo "âœ… æ— ç¼–è¯‘é”™è¯¯"
          fi

      - name: ä¿å­˜ç¼“å­˜
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/feeds
            ${{ env.SOURCE_DIR }}/staging_dir
            ${{ env.SOURCE_DIR }}/build_dir
          key: ${{ steps.restore-cache.outputs.cache-primary-key }}

      - name: å‡†å¤‡å›ºä»¶æ–‡ä»¶
        if: success()
        run: |
          mkdir -p artifacts
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶
          find $SOURCE_DIR/bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} artifacts/ \;
          echo "ðŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -lh artifacts/ || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"

      - name: ä¸Šä¼ åˆ°å·¥ä½œæµåˆ¶å“
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-mt7987-${{ github.run_number }}
          path: artifacts/
          retention-days: 14

      - name: åˆ›å»ºGitHubå‘å¸ƒç‰ˆ
        if: success()
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ github.run_number }}
          name: ImmortalWrt MT7987 æž„å»º #${{ github.run_number }}
          body: |
            ## ðŸš€ è‡ªåŠ¨æž„å»ºå®Œæˆ
            
            **æž„å»ºä¿¡æ¯**
            - è¿è¡ŒID: #${{ github.run_number }}
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            - ç¼“å­˜å‘½ä¸­: ${{ steps.restore-cache.outputs.cache-hit }}
            
            **é…ç½®ä¿®å¤**
            - âœ… å·²ä¿®å¤5Gè°ƒåˆ¶è§£è°ƒå™¨åŒ…å†²çª
            - âœ… ä½¿ç”¨QModem feedé©±åŠ¨
            - âœ… ç¦ç”¨å†²çªçš„mtk/5g-modemåŒ…
            
            **åŒ…å«åŠŸèƒ½**
            - QModem (4G/5Gè°ƒåˆ¶è§£è°ƒå™¨æ”¯æŒ)
            - AdGuardHome (DNSå¹¿å‘Šè¿‡æ»¤)
            - Mihomo (ä»£ç†å·¥å…·)
            - MTK WiFi 7é©±åŠ¨
            
            **ä½¿ç”¨è¯´æ˜Ž**
            1. ä¸‹è½½å¯¹åº”å›ºä»¶æ–‡ä»¶
            2. é€šè¿‡è·¯ç”±å™¨ç®¡ç†é¡µé¢åˆ·å…¥
            3. é¦–æ¬¡åˆ·æœºå»ºè®®ä¸ä¿ç•™é…ç½®
            
            > æ­¤ä¸ºç”±GitHub Actionsè‡ªåŠ¨æž„å»ºçš„æµ‹è¯•å›ºä»¶
          files: artifacts/*
          draft: false
          prerelease: true