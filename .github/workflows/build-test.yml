name: Build ImmortalWrt H5000M
on:
  schedule:
    - cron: '0 16 * * 0'
  workflow_dispatch:
    inputs:
      enable_adguardhome:
        description: 'å¯ç”¨ AdGuardHome'
        required: false
        default: true
        type: boolean
      enable_homeproxy:
        description: 'å¯ç”¨ HomeProxy'
        required: false
        default: false
        type: boolean
      enable_openclash:
        description: 'å¯ç”¨ OpenClash'
        required: false
        default: true
        type: boolean
      enable_mihomo:
        description: 'å¯ç”¨ Mihomo'
        required: false
        default: false
        type: boolean
      enable_upnp:
        description: 'å¯ç”¨ UPnP'
        required: false
        default: true
        type: boolean
      enable_vlmcsd:
        description: 'å¯ç”¨ VLMCSd'
        required: false
        default: true
        type: boolean
      enable_smartdns:
        description: 'å¯ç”¨ SmartDNS'
        required: false
        default: false
        type: boolean
      enable_mosdns:
        description: 'å¯ç”¨ MosDNS'
        required: false
        default: true
        type: boolean
      enable_dockerman:
        description: 'å¯ç”¨ DockerMan'
        required: false
        default: false
        type: boolean
      enable_qmodem_next:
        description: 'å¯ç”¨ QModem Next (æ–°ç‰ˆ) - ä¸æ—§ç‰ˆäº’æ–¥'
        required: false
        default: true
        type: boolean
      enable_qmodem:
        description: 'å¯ç”¨ QModem (æ—§ç‰ˆ) - ä¸æ–°ç‰ˆäº’æ–¥'
        required: false
        default: false
        type: boolean
      enable_mwan:
        description: 'å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_URL: https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/refs/heads/mt798x-mt799x-6.6-mtwifi/defconfig/mt7987_mt7992.config
  SOURCE_DIR: immortalwrt
  TZ: Asia/Shanghai

jobs:
  # ============================================================================
  # Job 1: ç¯å¢ƒå‡†å¤‡ (5-10 åˆ†é’Ÿ, å¯å¹¶è¡Œ)
  # ============================================================================
  prepare:
    runs-on: ubuntu-22.04
    steps:
      - name: ç¯å¢ƒæ¸…ç†å’Œå‡†å¤‡
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euxo pipefail
          echo "ğŸ§¹ [å‡†å¤‡é˜¶æ®µ] å¼€å§‹æ¸…ç†ç¯å¢ƒ..."
          df -h /

          # æ¸…ç† runner çš„è¯Šæ–­ç¼“å­˜ï¼ˆä¼šå¢é•¿å¹¶å æ»¡ç£ç›˜ï¼‰
          sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true

          # åˆ é™¤ Docker é•œåƒ/å®¹å™¨/ç¼“å­˜
          docker rmi $(docker images -q) 2>/dev/null || true
          docker system prune -f || true
          docker image prune -a -f || true
          docker volume prune -f || true

          # åˆ é™¤ä¸éœ€è¦çš„ç»„ä»¶
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android \
            /opt/ghc /etc/mysql /etc/php /usr/local/share/boost /usr/share/swift \
            /opt/hostedtoolcache /usr/local/.ghcup /usr/local/graalvm /imagegeneration 2>/dev/null || true

          # å¸è½½ä¸éœ€è¦çš„è½¯ä»¶
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* 2>/dev/null || true

          # æ¸…ç†ç¼“å­˜
          sudo apt-get clean && sudo apt-get autoclean && sudo rm -rf /var/lib/apt/lists/* 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* /var/log/* 2>/dev/null || true

          echo "ğŸ” åˆ—å‡º /home/runner ä¸‹æœ€å¤§çš„ç›®å½•ï¼ˆå‰ 25ï¼‰ä»¥ä¾¿è¯Šæ–­ï¼š"
          sudo du -sh /home/runner/* 2>/dev/null | sort -rh | head -n 25 || true

          # å¦‚æœå¯ç”¨ç©ºé—´è¿‡å°åˆ™æå‰å¤±è´¥ï¼Œé¿å…è¿è¡Œæ—¶å‡ºç° no space é”™è¯¯ï¼ˆå•ä½ï¼šKBï¼‰
          AVAIL_KB=$(df --output=avail / | tail -n1 | tr -d ' ')
          echo "âœ… å¯ç”¨ç£ç›˜ (KB): $AVAIL_KB"
          MIN_KB=$((6 * 1024 * 1024))
          if [ "$AVAIL_KB" -lt "$MIN_KB" ]; then
            echo "âŒ å¯ç”¨ç£ç›˜å°äº 6GB ($MIN_KB KB)ï¼Œè¯·æ¸…ç† runner æˆ–è°ƒæ•´ç¼“å­˜ç­–ç•¥ã€‚"
            df -h /
            exit 1
          fi

          # å®‰è£…ä¸»æœºæ„å»ºä¾èµ–ï¼ˆå¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ï¼‰
          echo "ğŸ”§ å®‰è£…ä¸»æœºæ„å»ºä¾èµ–..."
          sudo apt-get update || true
          sudo apt-get install -y build-essential git ccache pkg-config cmake python3 python3-pip libncurses5-dev libssl-dev libgmp3-dev libmbedtls-dev rustc cargo golang-go autoconf automake libtool patch make gcc g++ || true

          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
          df -h /

  # ============================================================================
  # Job 2: ä¸‹è½½æºç å’Œç¼–è¯‘é“¾ (20-30 åˆ†é’Ÿ, é¦–æ¬¡)
  # ============================================================================
  download:
    runs-on: ubuntu-22.04
    needs: prepare
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      config-hash: ${{ steps.config.outputs.hash }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: echo "key=${{ github.run_id }}-${{ github.ref }}" >> $GITHUB_OUTPUT

      - name: è®¡ç®—é…ç½®å“ˆå¸Œ
        id: config
        run: |
          # è®¡ç®—é…ç½®æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼Œç”¨äºåˆ¤æ–­é…ç½®æ˜¯å¦æ”¹å˜
          CONFIG_HASH=$(cat h5000m.config feeds.conf.default 2>/dev/null | md5sum | cut -d' ' -f1)
          echo "hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ é…ç½®å“ˆå¸Œ: $CONFIG_HASH"

      - name: æ¢å¤ç¼–è¯‘å·¥å…·é“¾ç¼“å­˜ (åŠ é€Ÿé¦–æ¬¡)
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
          key: ${{ runner.os }}-toolchain-${{ env.REPO_BRANCH }}-v1
          restore-keys: |
            ${{ runner.os }}-toolchain-${{ env.REPO_BRANCH }}-
            ${{ runner.os }}-toolchain-

      - name: å…‹éš†æºç 
        run: |
          echo "ğŸ“¥ [ä¸‹è½½é˜¶æ®µ] å…‹éš†æºç ..."
          if [ -d "$SOURCE_DIR/.git" ]; then
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fd
          else
            if [ -d "$SOURCE_DIR" ]; then
              echo "âš ï¸ $SOURCE_DIR å·²å­˜åœ¨ä¸”ä¸æ˜¯ git ä»“åº“ï¼Œå…ˆåˆ é™¤..."
              rm -rf "$SOURCE_DIR"
            fi
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          fi
          echo "âœ… æºç å…‹éš†å®Œæˆ"

      - name: è®¾ç½® feeds
        run: |
          cd $SOURCE_DIR
          echo "ğŸ”„ æ›´æ–°è½¯ä»¶æº..."
          
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          fi
          
          # æ ¹æ®è¾“å…¥æ¡ä»¶æ·»åŠ  feedsï¼Œé¿å…ä¸å¿…è¦çš„å…‹éš†
          if [ "${{ inputs.enable_mihomo }}" = "true" ]; then
            grep -q "mihomo" feeds.conf.default || echo 'src-git mihomo https://github.com/morytyann/OpenWrt-mihomo.git;main' >> feeds.conf.default
          fi
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] || [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            grep -q "qmodem" feeds.conf.default || echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
          fi
          
          # æ›´æ–° feedsï¼Œå…è®¸éƒ¨åˆ†å¤±è´¥
          ./scripts/feeds update -a 2>&1 | grep -E "^(Scanning|Updating)" || true
          ./scripts/feeds install -a -f 2>&1 | tail -5 || true
          
          echo "âœ… Feeds è®¾ç½®å®Œæˆ"

      - name: ä¿®å¤ä¾èµ–ï¼ˆè‡ªå®šä¹‰è¡¥ä¸ï¼‰
        run: |
          set -euxo pipefail
          cd $SOURCE_DIR
          echo "ğŸ”§ ä¾èµ–ä¿®å¤ä¸è¡¥ä¸åº”ç”¨..."

          echo "å…‹éš†é¢å¤–è½¯ä»¶åŒ…..."
          # åªå…‹éš†å¯ç”¨çš„åŒ…ï¼Œé¿å…ä¸å¿…è¦çš„å…‹éš†
          if [ "${{ inputs.enable_adguardhome }}" = "true" ]; then
            [ ! -d "package/luci-app-adguardhome" ] && \
              git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome || true
          fi

          # ä¿®å¤ AdGuardHome çš„å®‰è£…è„šæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [ "${{ inputs.enable_adguardhome }}" = "true" ]; then
            AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
            if [ -f "$AGH_LUCI_SCRIPT" ]; then
              # åœ¨ç§»åŠ¨/å¤åˆ¶å‰å…ˆæ¸…ç†å¹¶åˆ›å»ºæ­£ç¡®çš„ç›®å½•ç»“æ„
              sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
            fi

            # ä¿®å¤ AdGuardHome åˆå§‹åŒ–è„šæœ¬
            AGH_LUCI_INIT="package/luci-app-adguardhome/root/etc/init.d/AdGuardHome"
            if [ -f "$AGH_LUCI_INIT" ]; then
              # ç¡®ä¿ /usr/bin/AdGuardHome æ˜¯ç›®å½•
              sed -i '/^#!/a\\
            [ -f /usr/bin/AdGuardHome ] && rm -f /usr/bin/AdGuardHome && mkdir -p /usr/bin/AdGuardHome' "$AGH_LUCI_INIT" || true
            fi
          fi

          echo "ä¿®å¤ä¾èµ–è­¦å‘Š..."

          # 1. ç§»é™¤ä¸éœ€è¦çš„æœ‰é—®é¢˜çš„åŒ…
          rm -rf package/feeds/packages/exim 2>/dev/null || true
          rm -rf package/feeds/packages/onionshare-cli 2>/dev/null || true
          rm -rf package/feeds/packages/python-zope-event 2>/dev/null || true
          rm -rf package/feeds/packages/python-zope-interface 2>/dev/null || true

          # 2. ndisc6 å¤„ç†ï¼šä¼˜å…ˆä½¿ç”¨æºç è‡ªå¸¦ç‰ˆæœ¬ï¼Œç§»é™¤ QModem feed ä¸­çš„é‡å¤ç‰ˆæœ¬é¿å…å†²çª
          # padavanonly æºç åœ¨ package/mtk/applications/5g-modem/ndisc å·²åŒ…å« ndisc6
          rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true

          # 3. ä¿®å¤ kmod-mhi-wwan ä¾èµ– - ä¿®æ”¹ qmodem Makefile ç§»é™¤è¯¥ä¾èµ–
          QMODEM_MK="package/feeds/qmodem/qmodem/Makefile"
          if [ -f "$QMODEM_MK" ]; then
            # å°† kmod-mhi-wwan ä¾èµ–æ”¹ä¸ºæ³¨é‡Šï¼ˆç¦ç”¨ï¼‰
            sed -i 's/DEPENDS:=.*+kmod-mhi-wwan/# &/g' "$QMODEM_MK" || true
            sed -i 's/+kmod-mhi-wwan/+PACKAGE_luci-app-qmodem_GENERIC_MHI_PCIe_DRIVER:kmod-mhi-wwan/g' "$QMODEM_MK" || true
          fi

          # 3b. ç§»é™¤æœ‰é—®é¢˜çš„ä¾èµ–åŒ… Makefile å®šä¹‰æˆ–ç¦ç”¨å®ƒä»¬
          rm -rf package/feeds/packages/python-gevent 2>/dev/null || true
          rm -rf package/feeds/packages/python-twisted 2>/dev/null || true

          # 4. ä¿®å¤ mt_hwifi é©±åŠ¨çš„ kmod-mt_wifi_osal ä¾èµ–è­¦å‘Š
          MT_HWIFI_MK="package/mtk/drivers/mt_hwifi/Makefile"
          if [ -f "$MT_HWIFI_MK" ]; then
            # ç§»é™¤æˆ–æ³¨é‡Šæ‰ä¸å­˜åœ¨çš„ kmod-mt_wifi_osal ä¾èµ–
            sed -i 's/+kmod-mt_wifi_osal//g' "$MT_HWIFI_MK" || true
          fi

          # 5. ä¿®å¤ AdGuardHome å®‰è£…å†²çªï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [ "${{ inputs.enable_adguardhome }}" = "true" ]; then
            AGH_INIT="package/feeds/packages/adguardhome/files/etc/init.d/AdGuardHome"
            if [ -f "$AGH_INIT" ]; then
              # æ·»åŠ æ¸…ç†å’Œé‡å»ºé€»è¾‘åˆ°åˆå§‹åŒ–è„šæœ¬
              sed -i '/^#!/a\\
            # æ¸…ç†å†²çªçš„ /usr/bin/AdGuardHome è·¯å¾„\\
            [ -e /usr/bin/AdGuardHome ] && rm -rf /usr/bin/AdGuardHome\\
            mkdir -p /usr/bin/AdGuardHome' "$AGH_INIT" || true
            fi

            # åŒæ—¶ç§»é™¤åŒ…ä¸­çš„å†²çªæ–‡ä»¶å®šä¹‰
            rm -rf package/feeds/packages/adguardhome/files/usr/bin/AdGuardHome 2>/dev/null || true
          fi

          echo "ä¾èµ–ä¿®å¤å®Œæˆ"

      - name: è¯Šæ–­ï¼šå•åŒ…ç¼–è¯‘ ndisc6ï¼ˆä¸å½±å“æµæ°´çº¿å¤±è´¥ï¼‰
        continue-on-error: true
        run: |
          set -euxo pipefail
          cd $SOURCE_DIR
          echo "ğŸ”¬ ç°åœ¨å°è¯•å•åŒ…ç¼–è¯‘ package/feeds/qmodem/ndisc6ï¼Œä»¥ä¾¿æ•è·è¯¦ç»†é”™è¯¯ä¿¡æ¯..."
          rm -f /tmp/ndisc6_build.log || true
          if make package/feeds/qmodem/ndisc6/compile V=s -j1 2>&1 | tee /tmp/ndisc6_build.log; then
            echo "âœ… ndisc6 å•åŒ…ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ ndisc6 å•åŒ…ç¼–è¯‘å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ /tmp/ndisc6_build.log çš„è¯¦ç»†æ—¥å¿—"
            tail -n 200 /tmp/ndisc6_build.log || true
          fi

      - name: ä¸‹è½½ç¼–è¯‘ä¾èµ– (ä¼šç¼“å­˜)
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¦ [ä¸‹è½½é˜¶æ®µ] ä¸‹è½½ç¼–è¯‘ä¾èµ–..."
          
          for attempt in 1 2 3; do
            if make download -j16 2>&1 | tail -10; then
              echo "âœ… ä¾èµ–ä¸‹è½½æˆåŠŸ"
              exit 0
            fi
            echo "âš ï¸  ç¬¬ $attempt æ¬¡ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•..."
            find dl -size -1024c -delete 2>/dev/null || true
            sleep $((attempt * 5))
          done
          
          echo "âŒ ä¾èµ–ä¸‹è½½å¤±è´¥"
          exit 1

      - name: ç¼“å­˜ä¸‹è½½çš„ä¾èµ– (å…³é”®!)
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
          key: ${{ runner.os }}-downloads-${{ env.REPO_BRANCH }}-${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-downloads-${{ env.REPO_BRANCH }}-

  # ============================================================================
  # Job 3: ç¼–è¯‘å›ºä»¶ (30-90 åˆ†é’Ÿ, é¦–æ¬¡; 5-30 åˆ†é’Ÿ, åç»­)
  # ============================================================================
  build:
    runs-on: ubuntu-22.04
    needs: download
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
          key: ${{ runner.os }}-downloads-${{ env.REPO_BRANCH }}-${{ needs.download.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-downloads-${{ env.REPO_BRANCH }}-

      - name: æ¢å¤ ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ env.REPO_BRANCH }}-v1
          restore-keys: |
            ${{ runner.os }}-ccache-${{ env.REPO_BRANCH }}-

      - name: å…‹éš†æºç 
        run: |
          if [ ! -d "$SOURCE_DIR/.git" ]; then
            if [ -d "$SOURCE_DIR" ]; then
              echo "âš ï¸ $SOURCE_DIR å·²å­˜åœ¨ä¸”ä¸æ˜¯ git ä»“åº“ï¼Œå…ˆåˆ é™¤..."
              rm -rf "$SOURCE_DIR"
            fi
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          fi

      - name: è®¾ç½® feeds
        run: |
          cd $SOURCE_DIR
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          fi
          ./scripts/feeds update -a 2>&1 | grep -E "^(Scanning|Updating)" || true
          ./scripts/feeds install -a -f 2>&1 | tail -3 || true

      - name: ä¸‹è½½åŸºç¡€é…ç½®å¹¶åˆå¹¶
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¥ ä¸‹è½½åŸºç¡€é…ç½®..."
          
          curl -fsSL "$CONFIG_URL" -o base.config || {
            echo "âš ï¸ è¿œç¨‹é…ç½®ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°"
            [ -f "defconfig/mt7987_mt7992.config" ] && cp defconfig/mt7987_mt7992.config base.config
          }
          
          cat base.config > .config
          if [ -f "$GITHUB_WORKSPACE/h5000m.config" ]; then
            cat "$GITHUB_WORKSPACE/h5000m.config" >> .config
          fi
          echo "âœ… é…ç½®å·²åˆå¹¶"

      - name: åº”ç”¨æ’ä»¶é…ç½®
        run: |
          cd $SOURCE_DIR
          
          # éªŒè¯äº’æ–¥é€‰é¡¹
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] && [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨ QModem Next å’Œ QModemï¼"
            exit 1
          fi
          
          enable_pkg() { echo "CONFIG_PACKAGE_$1=y" >> .config; }
          disable_pkg() { echo "# CONFIG_PACKAGE_$1 is not set" >> .config; }
          
          # AdGuardHome
          [ "${{ inputs.enable_adguardhome }}" = "true" ] && {
            enable_pkg "luci-app-adguardhome"
            enable_pkg "adguardhome"
          } || {
            disable_pkg "luci-app-adguardhome"
            disable_pkg "adguardhome"
          }
          
          # HomeProxy
          [ "${{ inputs.enable_homeproxy }}" = "true" ] && enable_pkg "luci-app-homeproxy"
          
          # OpenClash
          if [ "${{ inputs.enable_openclash }}" = "true" ]; then
            enable_pkg "luci-app-openclash"
            enable_pkg "bash" "dnsmasq-full" "curl" "ca-bundle" "ip-full"
            enable_pkg "kmod-nft-tproxy" "luci-compat"
          else
            disable_pkg "luci-app-openclash"
            disable_pkg "kmod-nft-tproxy" "ip-full"
          fi
          
          # Mihomo
          [ "${{ inputs.enable_mihomo }}" = "true" ] && {
            enable_pkg "mihomo"
            enable_pkg "luci-app-mihomo"
          }
          
          # UPnP
          [ "${{ inputs.enable_upnp }}" = "true" ] && enable_pkg "luci-app-upnp" || disable_pkg "luci-app-upnp"
          
          # VLMCSd
          if [ "${{ inputs.enable_vlmcsd }}" = "true" ]; then
            enable_pkg "vlmcsd" "luci-app-vlmcsd"
          else
            disable_pkg "vlmcsd" "luci-app-vlmcsd"
          fi
          
          # SmartDNS
          [ "${{ inputs.enable_smartdns }}" = "true" ] && {
            enable_pkg "smartdns" "luci-app-smartdns"
          }
          
          # MosDNS
          if [ "${{ inputs.enable_mosdns }}" = "true" ]; then
            enable_pkg "mosdns" "luci-app-mosdns"
          else
            disable_pkg "mosdns" "luci-app-mosdns"
          fi
          
          # DockerMan
          [ "${{ inputs.enable_dockerman }}" = "true" ] && {
            enable_pkg "docker" "luci-app-dockerman"
          }
          
          # QModem
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ]; then
            enable_pkg "luci-app-qmodem-next"
          elif [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            enable_pkg "luci-app-qmodem"
          fi
          
          # MWAN
          [ "${{ inputs.enable_mwan }}" = "true" ] && {
            enable_pkg "mwan3" "luci-app-mwan3"
          }
          
          make defconfig || true
          echo "âœ… æ’ä»¶é…ç½®å·²åº”ç”¨"

      - name: éªŒè¯é…ç½®
        run: |
          cd $SOURCE_DIR
          echo "ğŸ” éªŒè¯é…ç½®..."
          check_pkg() {
            grep -q "CONFIG_PACKAGE_$1=y" .config && echo "âœ… $2: å¯ç”¨" || echo "âš ï¸  $2: ç¦ç”¨/æœªé…ç½®"
          }
          check_pkg "luci-app-adguardhome" "AdGuardHome"
          check_pkg "luci-app-openclash" "OpenClash"
          check_pkg "docker" "Docker"

      - name: è¯Šæ–­ï¼šä¸»æœºåŒ…å•ç¼–è¯‘ï¼ˆgmp/openssl/mbedtls/golang/rustï¼‰
        continue-on-error: true
        run: |
          set -euxo pipefail
          cd $SOURCE_DIR
          packages=(
            "package/libs/gmp"
            "package/libs/openssl"
            "package/libs/mbedtls"
            "package/feeds/packages/golang"
            "package/feeds/packages/rust"
          )
          for p in "${packages[@]}"; do
            base=$(basename "$p")
            echo "==== ç¼–è¯‘ $p host (V=s) ===="
            rm -f /tmp/${base}_host_build.log || true
            if make ${p}/host/compile V=s -j1 2>&1 | tee /tmp/${base}_host_build.log; then
              echo "âœ… $p ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ $p ç¼–è¯‘å¤±è´¥ï¼Œè¾“å‡ºæœ€å 200 è¡Œæ—¥å¿—ï¼š"
              tail -n 200 /tmp/${base}_host_build.log || true
            fi
          done

      - name: ä¿å­˜ä¸»æœºä¾èµ–è¯Šæ–­æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: host-deps-logs-${{ github.run_number }}
          path: /tmp/*_host_build.log
          retention-days: 1

      - name: ç¼–è¯‘å‰ç£ç›˜æ£€æŸ¥
        run: |
          set -euxo pipefail
          echo "ğŸ” [ç¼–è¯‘å‰] æ£€æŸ¥ç£ç›˜ç©ºé—´..."
          df -h /
          AVAIL_KB=$(df --output=avail / | tail -n1 | tr -d ' ')
          echo "âœ… å¯ç”¨ç£ç›˜ (KB): $AVAIL_KB"
          MIN_KB=$((4 * 1024 * 1024))  # 4GB é˜ˆå€¼
          if [ "$AVAIL_KB" -lt "$MIN_KB" ]; then
            echo "âŒ å¯ç”¨ç£ç›˜å°äº 4GB ($MIN_KB KB)ï¼Œå°è¯•æ¸…ç†å¤šä½™æ–‡ä»¶..."
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜
            sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* 2>/dev/null || true
            sudo rm -rf ${{ env.SOURCE_DIR }}/build_dir/* ${{ env.SOURCE_DIR }}/staging_dir/target-* ${{ env.SOURCE_DIR }}/bin/targets/* 2>/dev/null || true
            docker system prune -af || true
            sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
            # é‡æ–°æ£€æŸ¥
            df -h /
            AVAIL_KB_NEW=$(df --output=avail / | tail -n1 | tr -d ' ')
            echo "âœ… æ¸…ç†åå¯ç”¨ç£ç›˜ (KB): $AVAIL_KB_NEW"
            if [ "$AVAIL_KB_NEW" -lt "$MIN_KB" ]; then
              echo "âŒ æ¸…ç†åä»ä¸è¶³ï¼Œè¯·æ‰‹åŠ¨æ¸…ç† runnerã€‚"
              exit 1
            fi
            echo "âœ… æ¸…ç†æˆåŠŸï¼Œç£ç›˜ç©ºé—´å……è¶³ï¼Œå¼€å§‹ç¼–è¯‘"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³ï¼Œå¼€å§‹ç¼–è¯‘"
          fi

      - name: ç¼–è¯‘å›ºä»¶ (å¤šçº¿ç¨‹)
        run: |
          cd $SOURCE_DIR
          THREADS=$(($(nproc) + 1))
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "ğŸ”¨ [ç¼–è¯‘é˜¶æ®µ] ä½¿ç”¨ $THREADS çº¿ç¨‹ç¼–è¯‘..."
          START_TIME=$(date +%s)
          
          if make -j$THREADS V=s BUILD_LOG=1 IGNORE_ERRORS=m 2>&1 | tee /tmp/build.log | tail -30; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "âœ… ç¼–è¯‘æˆåŠŸ (è€—æ—¶: ${DURATION}s)"
          else
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            if make -j1 V=s 2>&1 | tee /tmp/build_single.log | tail -50; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥"
              tail -100 /tmp/build_single.log
              exit 1
            fi
          fi

      - name: ç¼“å­˜å‰ç£ç›˜æ£€æŸ¥
        run: |
          set -euxo pipefail
          echo "ğŸ” [ç¼“å­˜å‰] æ£€æŸ¥ç£ç›˜ç©ºé—´..."
          df -h /
          AVAIL_KB=$(df --output=avail / | tail -n1 | tr -d ' ')
          echo "âœ… å¯ç”¨ç£ç›˜ (KB): $AVAIL_KB"
          MIN_KB=$((3 * 1024 * 1024))  # 3GB é˜ˆå€¼ï¼Œç¼“å­˜å‰æ›´ä¸¥æ ¼
          if [ "$AVAIL_KB" -lt "$MIN_KB" ]; then
            echo "âŒ å¯ç”¨ç£ç›˜å°äº 3GB ($MIN_KB KB)ï¼Œå°è¯•æ¸…ç†å¤šä½™æ–‡ä»¶..."
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜
            sudo rm -rf /tmp/* /var/tmp/* ~/.cache/* 2>/dev/null || true
            sudo rm -rf ${{ env.SOURCE_DIR }}/build_dir/* ${{ env.SOURCE_DIR }}/staging_dir/target-* ${{ env.SOURCE_DIR }}/bin/targets/* 2>/dev/null || true
            docker system prune -af || true
            sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
            # é‡æ–°æ£€æŸ¥
            df -h /
            AVAIL_KB_NEW=$(df --output=avail / | tail -n1 | tr -d ' ')
            echo "âœ… æ¸…ç†åå¯ç”¨ç£ç›˜ (KB): $AVAIL_KB_NEW"
            if [ "$AVAIL_KB_NEW" -lt "$MIN_KB" ]; then
              echo "âŒ æ¸…ç†åä»ä¸è¶³ï¼Œè¯·æ‰‹åŠ¨æ¸…ç† runnerã€‚"
              exit 1
            fi
            echo "âœ… æ¸…ç†æˆåŠŸï¼Œç£ç›˜ç©ºé—´å……è¶³ï¼Œå¼€å§‹ç¼“å­˜"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³ï¼Œå¼€å§‹ç¼“å­˜"
          fi

      - name: ä¿å­˜ç¼–è¯‘ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
            # å…¨éƒ¨ç¼“å­˜ staging_dir ä»¥åŠ é€Ÿåç»­æ„å»º
          key: ${{ runner.os }}-build-${{ env.REPO_BRANCH }}-${{ needs.download.outputs.cache-key }}

      - name: ç¼–è¯‘åæ¸…ç† (é‡Šæ”¾ç£ç›˜)
        if: always()
        run: |
          set -euxo pipefail
          echo "ğŸ”§ [æ¸…ç†] é‡Šæ”¾ç£ç›˜ç©ºé—´..."
          # åˆ é™¤æ„å»ºä¸´æ—¶ç›®å½•å’Œ targetï¼ˆtarget-* é€šå¸¸å¾ˆå¤§ï¼Œç”±ç¼“å­˜ç®¡ç†ï¼‰
          rm -rf ${{ env.SOURCE_DIR }}/build_dir/* ${{ env.SOURCE_DIR }}/staging_dir/target-* ${{ env.SOURCE_DIR }}/bin/targets/* 2>/dev/null || true
          # æ¸…ç† docker
          docker system prune -af || true
          # æ¸…ç† runner å‚¨å­˜çš„è¯Šæ–­æ—¥å¿—
          sudo rm -rf /home/runner/actions-runner/cached/_diag/* 2>/dev/null || true
          df -h

      - name: ä¸Šä¼ ç¼–è¯‘ç»“æœ
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-result-${{ github.run_number }}
          path: ${{ env.SOURCE_DIR }}/bin
          retention-days: 1

  # ============================================================================
  # Job 4: æ‰“åŒ…å’Œå‘å¸ƒ (5-10 åˆ†é’Ÿ)
  # ============================================================================
  package:
    runs-on: ubuntu-22.04
    needs: build
    if: success()
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ä¸‹è½½ç¼–è¯‘ç»“æœ
        uses: actions/download-artifact@v4
        with:
          name: build-result-${{ github.run_number }}
          path: ${{ env.SOURCE_DIR }}/bin

      - name: æ‰“åŒ…äº§ç‰©
        run: |
          mkdir -p artifacts
          cd $SOURCE_DIR
          
          if [ ! -d "bin/targets" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡º"
            exit 1
          fi
          
          echo "ğŸ“¦ æ”¶é›†äº§ç‰©..."
          find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} $GITHUB_WORKSPACE/artifacts/ \; 2>/dev/null || true
          
          if [ -z "$(ls -A $GITHUB_WORKSPACE/artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ:"
          cd $GITHUB_WORKSPACE/artifacts
          ls -lh

      - name: ç”Ÿæˆäº§ç‰©æ¸…å•
        run: |
          cat > $GITHUB_WORKSPACE/artifacts/MANIFEST.txt << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ImmortalWrt H5000M å›ºä»¶æ„å»ºä¿¡æ¯             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“… æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}
          ğŸ·ï¸  Build #: ${{ github.run_number }}
          
          âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:
          EOF
          
          echo "  â€¢ AdGuardHome:  ${{ inputs.enable_adguardhome }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ HomeProxy:    ${{ inputs.enable_homeproxy }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ OpenClash:    ${{ inputs.enable_openclash }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ Mihomo:       ${{ inputs.enable_mihomo }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ UPnP:         ${{ inputs.enable_upnp }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ VLMCSd:       ${{ inputs.enable_vlmcsd }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ SmartDNS:     ${{ inputs.enable_smartdns }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ MosDNS:       ${{ inputs.enable_mosdns }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ DockerMan:    ${{ inputs.enable_dockerman }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ QModem Next:  ${{ inputs.enable_qmodem_next }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ QModem:       ${{ inputs.enable_qmodem }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "  â€¢ MWAN:         ${{ inputs.enable_mwan }}" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          
          echo "" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          echo "ğŸ“¦ äº§ç‰©æ–‡ä»¶:" >> $GITHUB_WORKSPACE/artifacts/MANIFEST.txt
          cd $GITHUB_WORKSPACE/artifacts
          ls -lh | grep -v "^total" | awk '{print "  â€¢ " $9 " (" $5 ")"}' >> MANIFEST.txt

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-H5000M-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt H5000M #${{ github.run_number }}
          body: |
            ğŸ‰ **ImmortalWrt H5000M å›ºä»¶å·²æ„å»ºå®Œæˆ**
            
            ğŸ“… æ—¶é—´: ${{ github.event.repository.updated_at }}
            
            **âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:**
            - AdGuardHome: ${{ inputs.enable_adguardhome }}
            - OpenClash: ${{ inputs.enable_openclash }}
            - Mihomo: ${{ inputs.enable_mihomo }}
            - MosDNS: ${{ inputs.enable_mosdns }}
            - Docker: ${{ inputs.enable_dockerman }}
            - MWAN: ${{ inputs.enable_mwan }}
            
            ğŸ’¾ ä¸‹è½½äº§ç‰©: è§ä¸‹æ–¹ Artifacts
            ğŸ“‹ è¯¦ç»†ä¿¡æ¯: è§ MANIFEST.txt
          prerelease: false
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}