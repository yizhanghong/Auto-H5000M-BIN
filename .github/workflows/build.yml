name: Build ImmortalWrt MT798x

on:
  schedule:
    - cron: '0 16 * * 0'  # æ¯å‘¨ä¸€åŒ—äº¬æ—¶é—´ 0:00
  workflow_dispatch:

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_FILE: mt7987_mt7992.config
  TZ: Asia/Shanghai
  SOURCE_DIR: immortalwrt

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "========== æ¸…ç†å‰ç£ç›˜ç©ºé—´ =========="
          df -h
          
          # åˆ é™¤ Docker é•œåƒ
          docker rmi $(docker images -q) 2>/dev/null || true
          
          # åˆ é™¤ä¸éœ€è¦çš„å¤§åž‹ç»„ä»¶
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android \
            /opt/ghc /etc/mysql /etc/php /usr/local/share/boost /usr/share/swift \
            /opt/hostedtoolcache /usr/local/.ghcup /usr/local/graalvm /imagegeneration
          
          # å¸è½½ä¸éœ€è¦çš„è½¯ä»¶
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* || true
          
          # æ›´æ–°å¹¶å®‰è£…ä¾èµ–
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint \
            binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler \
            ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged \
            help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
            libpython3-dev libreadline-dev libssl-dev libtool lld llvm lrzsz mkisofs msmtp \
            nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply \
            python3-pyelftools python3-setuptools qemu-utils re2c rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs unzip upx-ucl vim wget xmlto xxd zlib1g-dev
          
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          
          # è®¾ç½®æ—¶åŒº
          sudo timedatectl set-timezone "$TZ"
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          echo "========== æ¸…ç†åŽç£ç›˜ç©ºé—´ =========="
          df -h
          
          # éªŒè¯ç©ºé—´
          AVAIL_GB=$(df -BG /home/runner | tail -1 | awk '{print int($4)}')
          echo "ðŸ–¥ï¸ Runner: $(nproc) cores, $(free -g | awk '/Mem:/{print $2}')GB RAM"
          echo "ðŸ’¾ å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ env.CONFIG_FILE }}
          max-size: 5G

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ github.run_id }}
          restore-keys: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-

      - name: Clone source & setup feeds
        run: |
          # ccache ä¼˜åŒ–
          ccache --set-config=compression=true --set-config=compression_level=6
          ccache --set-config=sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime
          
          # å…‹éš†æºç 
          git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
          cd $SOURCE_DIR
          
          # æ·»åŠ  QModem feed & æ›´æ–°
          grep -q "qmodem" feeds.conf.default || echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
          ./scripts/feeds update -a && ./scripts/feeds install -a -f

      - name: Create Modem WebUI package
        run: |
          git clone --depth=1 https://github.com/snowflakexuehui/Modem_Webui.git modem_webui_src
          PKG=$SOURCE_DIR/package/modem-webui
          mkdir -p $PKG/files/{www/modem-webui,etc/uci-defaults,etc/hotplug.d/iface}
          
          # å¤åˆ¶é™æ€æ–‡ä»¶ & åŠ¨æ€é…ç½®
          cp -r modem_webui_src/web/* $PKG/files/www/modem-webui/
          echo '(function(){window.MODEM_WEBUI_CONFIG={status:"true",at:{host:window.location.hostname,port:8765}}})();' > $PKG/files/www/modem-webui/dynamic-config.js
          [ -f "$PKG/files/www/modem-webui/index.html" ] && sed -i 's|<head>|<head><script src="dynamic-config.js"></script>|' $PKG/files/www/modem-webui/index.html
          
          # UCI é»˜è®¤é…ç½®
          cat > $PKG/files/etc/uci-defaults/99-modem-webui << 'EOF'
          #!/bin/sh
          cat > /usr/bin/update-modem-webui-config << 'INNER'
          #!/bin/sh
          LAN_IP=$(uci get network.lan.ipaddr 2>/dev/null | cut -d'/' -f1)
          echo "{\"status\":\"true\",\"at\":{\"host\":\"\",\"port\":8765},\"_lan_ip\":\"${LAN_IP:-192.168.1.1}\"}" > /www/modem-webui/config.json
          INNER
          chmod +x /usr/bin/update-modem-webui-config && /usr/bin/update-modem-webui-config
          EOF
          chmod +x $PKG/files/etc/uci-defaults/99-modem-webui
          
          # Hotplug
          echo '#!/bin/sh' > $PKG/files/etc/hotplug.d/iface/99-modem-webui
          echo '[ "$ACTION" = "ifup" ] && [ "$INTERFACE" = "lan" ] && /usr/bin/update-modem-webui-config' >> $PKG/files/etc/hotplug.d/iface/99-modem-webui
          chmod +x $PKG/files/etc/hotplug.d/iface/99-modem-webui
          
          # Makefile
          cat > $PKG/Makefile << 'EOF'
          include $(TOPDIR)/rules.mk
          PKG_NAME:=modem-webui
          PKG_VERSION:=1.0.0
          PKG_RELEASE:=1
          include $(INCLUDE_DIR)/package.mk
          define Package/modem-webui
            SECTION:=net
            CATEGORY:=Network
            TITLE:=Modem Manager WebUI
            DEPENDS:=+uhttpd
            PKGARCH:=all
          endef
          define Build/Compile
          endef
          define Package/modem-webui/install
          	$(CP) ./files/* $(1)/
          endef
          $(eval $(call BuildPackage,modem-webui))
          EOF
          rm -rf modem_webui_src

      - name: Configure build
        run: |
          cd $SOURCE_DIR
          cp -f defconfig/$CONFIG_FILE .config
          
          # ç§»é™¤æ—§ modem é…ç½®
          sed -i '/CONFIG_PACKAGE_luci-app-modem\|CONFIG_PACKAGE_luci-app-3ginfo-lite\|CONFIG_PACKAGE_luci-app-sms-tool/d' .config
          
          # æ·»åŠ æ‰€éœ€åŒ…é…ç½®
          cat >> .config << 'EOF'
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_qmodem=y
          CONFIG_PACKAGE_luci-app-qmodem=y
          CONFIG_PACKAGE_sms-tool_q=y
          CONFIG_PACKAGE_quectel-cm-5g=y
          CONFIG_PACKAGE_luci-app-qmodem-mwan=y
          CONFIG_PACKAGE_mwan3=y
          CONFIG_PACKAGE_luci-app-mwan3=y
          CONFIG_PACKAGE_luci-app-upnp=y
          CONFIG_PACKAGE_luci-app-vlmcsd=y
          CONFIG_PACKAGE_vlmcsd=y
          CONFIG_PACKAGE_luci-app-adguardhome=y
          CONFIG_PACKAGE_adguardhome=y
          CONFIG_PACKAGE_luci-app-ramfree=y
          CONFIG_PACKAGE_luci-app-homeproxy=y
          CONFIG_PACKAGE_modem-webui=y
          CONFIG_CCACHE=y
          EOF
          make defconfig

      - name: Download & Compile
        run: |
          cd $SOURCE_DIR
          THREADS=$(($(nproc) + 1))
          export PATH="/usr/lib/ccache:$PATH"
          
          # ä¸‹è½½ï¼ˆå¸¦é‡è¯•ï¼‰
          for i in 1 2 3; do make download -j8 && break; find dl -size -1024c -delete 2>/dev/null; sleep 3; done
          
          # ç¼–è¯‘
          echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS} çº¿ç¨‹)..."
          make -j$THREADS BUILD_LOG=1 || make -j1 V=s
          
          # ccache ç»Ÿè®¡
          echo "ðŸ“Š ccache:" && ccache -s | grep -E "(hit rate|Hits|Misses)" || true

      - name: Prepare & Upload artifacts
        run: |
          mkdir -p artifacts
          find $SOURCE_DIR/bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} artifacts/ \;
          ls -lh artifacts/

      - name: Upload to Actions
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-MT7987-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt MT7987/MT7992 #${{ github.run_number }}
          body: |
            ðŸ”§ è‡ªåŠ¨æž„å»º ImmortalWrt MT7987/MT7992 å›ºä»¶
            ðŸ“… æ—¶é—´: ${{ github.event.repository.updated_at }}
            ðŸŒ¿ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
