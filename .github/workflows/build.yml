name: Build ImmortalWrt MT798x

on:
  schedule:
    - cron: '0 16 * * 0'  # æ¯å‘¨ä¸€åŒ—äº¬æ—¶é—´ 0:00
  workflow_dispatch:

# æ·»åŠ æƒé™å£°æ˜ï¼Œå…è®¸åˆ›å»º Release
permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi
  CONFIG_FILE: mt7987_mt7992.config
  TZ: Asia/Shanghai
  SOURCE_DIR: immortalwrt

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "========== æ¸…ç†å‰ç£ç›˜ç©ºé—´ =========="
          df -h
          
          # åˆ é™¤ Docker é•œåƒ
          docker rmi $(docker images -q) 2>/dev/null || true
          
          # åˆ é™¤ä¸éœ€è¦çš„å¤§å‹ç»„ä»¶
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android \
            /opt/ghc /etc/mysql /etc/php /usr/local/share/boost /usr/share/swift \
            /opt/hostedtoolcache /usr/local/.ghcup /usr/local/graalvm /imagegeneration
          
          # å¸è½½ä¸éœ€è¦çš„è½¯ä»¶
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* || true
          
          # æ›´æ–°å¹¶å®‰è£…ä¾èµ–
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint \
            binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler \
            ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged \
            help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
            libpython3-dev libreadline-dev libssl-dev libtool lld llvm lrzsz mkisofs msmtp \
            nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply \
            python3-pyelftools python3-setuptools qemu-utils re2c rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs unzip upx-ucl vim wget xmlto xxd zlib1g-dev
          
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          
          # è®¾ç½®æ—¶åŒº
          sudo timedatectl set-timezone "$TZ"
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          echo "========== æ¸…ç†åç£ç›˜ç©ºé—´ =========="
          df -h
          
          # éªŒè¯ç©ºé—´
          AVAIL_GB=$(df -BG /home/runner | tail -1 | awk '{print int($4)}')
          echo "ğŸ–¥ï¸ Runner: $(nproc) cores, $(free -g | awk '/Mem:/{print $2}')GB RAM"
          echo "ğŸ’¾ å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ env.CONFIG_FILE }}
          max-size: 8G
          save: true

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
            ${{ env.SOURCE_DIR }}/build_dir/host
            ${{ env.SOURCE_DIR }}/build_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-

      - name: Clone source & setup feeds
        run: |
          # ccache ä¼˜åŒ– - æ›´æ¿€è¿›çš„é…ç½®
          ccache --set-config=compression=true --set-config=compression_level=6
          ccache --set-config=sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime,pch_defines,locale
          ccache --set-config=max_size=8G
          ccache --set-config=depend_mode=true
          
          # å…‹éš†æˆ–æ›´æ–°æºç 
          if [ -d "$SOURCE_DIR/.git" ]; then
            echo "æºç ç›®å½•å·²å­˜åœ¨ï¼Œæ›´æ–°ä¸­..."
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fd
          else
            echo "é¦–æ¬¡å…‹éš†æºç ..."
            rm -rf $SOURCE_DIR
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
            cd $SOURCE_DIR
          fi
          
          # æ·»åŠ  QModem feed & æ›´æ–°
          grep -q "qmodem" feeds.conf.default || echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
          # æ·»åŠ  Mihomo feed
          grep -q "mihomo" feeds.conf.default || echo 'src-git mihomo https://github.com/morytyann/OpenWrt-mihomo.git;main' >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a -f
          
          # ======== å…‹éš†é¢å¤–çš„è½¯ä»¶åŒ… ========
          echo "å…‹éš†é¢å¤–è½¯ä»¶åŒ…..."
          
          # å…‹éš† luci-app-adguardhome (å¦‚æœä¸å­˜åœ¨)
          [ ! -d "package/luci-app-adguardhome" ] && \
            git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome
          
          # ä¿®å¤ luci-app-adguardhome çš„å®‰è£…è„šæœ¬ï¼ˆ/usr/bin/AdGuardHome è·¯å¾„å†²çªé—®é¢˜ï¼‰
          # é—®é¢˜ï¼šè„šæœ¬å‡è®¾ /usr/bin/AdGuardHome æ˜¯ç›®å½•ï¼Œä½†å¯èƒ½æ˜¯æ–‡ä»¶
          AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
          if [ -f "$AGH_LUCI_SCRIPT" ]; then
            # åœ¨ç§»åŠ¨/å¤åˆ¶å‰å…ˆæ¸…ç†å¹¶åˆ›å»ºæ­£ç¡®çš„ç›®å½•ç»“æ„
            sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
          fi
          
          # ä¿®å¤ AdGuardHome åˆå§‹åŒ–è„šæœ¬
          AGH_LUCI_INIT="package/luci-app-adguardhome/root/etc/init.d/AdGuardHome"
          if [ -f "$AGH_LUCI_INIT" ]; then
            # ç¡®ä¿ /usr/bin/AdGuardHome æ˜¯ç›®å½•
            sed -i '/^#!/a\
          [ -f /usr/bin/AdGuardHome ] && rm -f /usr/bin/AdGuardHome && mkdir -p /usr/bin/AdGuardHome' "$AGH_LUCI_INIT" || true
          fi
          
          # ======== ä¿®å¤ä¾èµ– WARNING ========
          echo "ä¿®å¤ä¾èµ–è­¦å‘Š..."
          
          # 1. ç§»é™¤ä¸éœ€è¦çš„æœ‰é—®é¢˜çš„åŒ…
          rm -rf package/feeds/packages/exim 2>/dev/null || true
          rm -rf package/feeds/packages/onionshare-cli 2>/dev/null || true
          rm -rf package/feeds/packages/python-zope-event 2>/dev/null || true
          rm -rf package/feeds/packages/python-zope-interface 2>/dev/null || true
          
          # 2. ndisc6 å¤„ç†ï¼šä¼˜å…ˆä½¿ç”¨æºç è‡ªå¸¦ç‰ˆæœ¬ï¼Œç§»é™¤ QModem feed ä¸­çš„é‡å¤ç‰ˆæœ¬é¿å…å†²çª
          # padavanonly æºç åœ¨ package/mtk/applications/5g-modem/ndisc å·²åŒ…å« ndisc6
          rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true
          
          # 3. ä¿®å¤ kmod-mhi-wwan ä¾èµ– - ä¿®æ”¹ qmodem Makefile ç§»é™¤è¯¥ä¾èµ–
          # qmodem åŒ…é»˜è®¤ä½¿ç”¨ vendor é©±åŠ¨ (pcie_mhi)ï¼Œä¸éœ€è¦ generic mhi-wwan
          QMODEM_MK="package/feeds/qmodem/qmodem/Makefile"
          if [ -f "$QMODEM_MK" ]; then
            # å°† kmod-mhi-wwan ä¾èµ–æ”¹ä¸ºæ³¨é‡Šï¼ˆç¦ç”¨ï¼‰
            sed -i 's/DEPENDS:=.*+kmod-mhi-wwan/# &/g' "$QMODEM_MK" || true
            sed -i 's/+kmod-mhi-wwan/+PACKAGE_luci-app-qmodem_GENERIC_MHI_PCIe_DRIVER:kmod-mhi-wwan/g' "$QMODEM_MK" || true
          fi
          
          # 3b. ç§»é™¤æœ‰é—®é¢˜çš„ä¾èµ–åŒ… Makefile å®šä¹‰æˆ–ç¦ç”¨å®ƒä»¬
          rm -rf package/feeds/packages/python-gevent 2>/dev/null || true
          rm -rf package/feeds/packages/python-twisted 2>/dev/null || true
          
          # 4. ä¿®å¤ mt_hwifi é©±åŠ¨çš„ kmod-mt_wifi_osal ä¾èµ–è­¦å‘Š
          # æ³¨æ„ï¼šä¸èƒ½åˆ é™¤ mt_hwifiï¼Œå¦åˆ™ WiFi æ— æ³•å·¥ä½œï¼
          # åªéœ€å¿½ç•¥è¿™ä¸ªè­¦å‘Šï¼Œæˆ–è€…ä¿®å¤ Makefile ä¸­çš„ä¾èµ–
          MT_HWIFI_MK="package/mtk/drivers/mt_hwifi/Makefile"
          if [ -f "$MT_HWIFI_MK" ]; then
            # ç§»é™¤æˆ–æ³¨é‡Šæ‰ä¸å­˜åœ¨çš„ kmod-mt_wifi_osal ä¾èµ–
            sed -i 's/+kmod-mt_wifi_osal//g' "$MT_HWIFI_MK" || true
          fi
          
          # 5. ä¿®å¤ AdGuardHome å®‰è£…å†²çª
          # æƒ…å†µï¼šAdGuardHome ä¸‹è½½è„šæœ¬è¯•å›¾å°†æ–‡ä»¶ç§»åŠ¨åˆ° /usr/bin/AdGuardHomeï¼Œä½†è·¯å¾„å†²çª
          # è§£å†³ï¼šä¿®æ”¹ AdGuardHome åŒ…çš„å®‰è£…è„šæœ¬ï¼Œæ¸…ç†å¹¶æ­£ç¡®åˆ›å»ºç›®å½•
          AGH_INIT="package/feeds/packages/adguardhome/files/etc/init.d/AdGuardHome"
          if [ -f "$AGH_INIT" ]; then
            # æ·»åŠ æ¸…ç†å’Œé‡å»ºé€»è¾‘åˆ°åˆå§‹åŒ–è„šæœ¬
            sed -i '/^#!/a\
          # æ¸…ç†å†²çªçš„ /usr/bin/AdGuardHome è·¯å¾„\
          [ -e /usr/bin/AdGuardHome ] && rm -rf /usr/bin/AdGuardHome\
          mkdir -p /usr/bin/AdGuardHome' "$AGH_INIT" || true
          fi
          
          # åŒæ—¶ç§»é™¤åŒ…ä¸­çš„å†²çªæ–‡ä»¶å®šä¹‰
          rm -rf package/feeds/packages/adguardhome/files/usr/bin/AdGuardHome 2>/dev/null || true
          
          echo "ä¾èµ–ä¿®å¤å®Œæˆ"


      - name: Configure build
        run: |
          cd $SOURCE_DIR
          cp -f defconfig/$CONFIG_FILE .config
          
          # ç§»é™¤æ—§ modem é…ç½®
          sed -i '/CONFIG_PACKAGE_luci-app-modem\|CONFIG_PACKAGE_luci-app-3ginfo-lite\|CONFIG_PACKAGE_luci-app-sms-tool/d' .config
          
          # æ·»åŠ æ‰€éœ€åŒ…é…ç½®
          cat >> .config << 'EOF'
          # ======== QModem æ ¸å¿ƒ ========
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_qmodem=y
          CONFIG_PACKAGE_luci-app-qmodem=y
          
          # QModem é©±åŠ¨é€‰æ‹© - ä½¿ç”¨ Vendor é©±åŠ¨
          CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_vendor-qmi-wwan=y
          # CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_generic-qmi-wwan is not set
          
          # QModem IPv6 æ”¯æŒ
          CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_ndisc6=y
          # CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_rdisc6 is not set
          # CONFIG_PACKAGE_luci-app-qmodem_INCLUDE_no_ndisc_rdisc6 is not set
          CONFIG_PACKAGE_ndisc6=y
          
          # QModem Quectel CM é€‰æ‹© - ä½¿ç”¨ Tom å®šåˆ¶ç‰ˆ
          CONFIG_PACKAGE_luci-app-qmodem_USE_TOM_CUSTOMIZED_QUECTEL_CM=y
          # CONFIG_PACKAGE_luci-app-qmodem_USING_QWRT_QUECTEL_CM_5G is not set
          # CONFIG_PACKAGE_luci-app-qmodem_USING_NORMAL_QUECTEL_CM is not set
          CONFIG_PACKAGE_quectel-CM-5G-M=y
          
          # QModem ä¾èµ–å·¥å…·
          CONFIG_PACKAGE_sms-tool_q=y
          CONFIG_PACKAGE_ubus-at-daemon=y
          CONFIG_PACKAGE_tom_modem=y
          
          # QModem Vendor QMI é©±åŠ¨
          CONFIG_PACKAGE_kmod-qmi_wwan_q=y
          CONFIG_PACKAGE_kmod-qmi_wwan_f=y
          CONFIG_PACKAGE_kmod-qmi_wwan_s=y
          
          # QModem MWAN (å¤šWANè´Ÿè½½å‡è¡¡)
          CONFIG_PACKAGE_luci-app-qmodem-mwan=y
          CONFIG_PACKAGE_mwan3=y
          CONFIG_PACKAGE_luci-app-mwan3=y
          
          # ======== å¸¸ç”¨è½¯ä»¶ ========
          CONFIG_PACKAGE_luci-app-upnp=y
          CONFIG_PACKAGE_luci-app-vlmcsd=y
          CONFIG_PACKAGE_vlmcsd=y
          CONFIG_PACKAGE_smartdns=y
          CONFIG_PACKAGE_luci-app-adguardhome=y
          CONFIG_PACKAGE_adguardhome=y
          CONFIG_PACKAGE_luci-app-ramfree=y
          CONFIG_PACKAGE_nikki=y
          CONFIG_PACKAGE_luci-app-nikki=y
          CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y
          CONFIG_PACKAGE_mihomo=y
          CONFIG_PACKAGE_luci-app-mihomo=y
          CONFIG_PACKAGE_luci-i18n-mihomo-zh-cn=y
          CONFIG_PACKAGE_ca-bundle=y
          CONFIG_PACKAGE_curl=y
          CONFIG_PACKAGE_yq=y
          CONFIG_PACKAGE_firewall4=y
          CONFIG_PACKAGE_kmod-nft-tproxy=y
          CONFIG_PACKAGE_ip-full=y
          CONFIG_PACKAGE_kmod-tun=y
          
          # ======== LuCI ä¸»é¢˜ ========
          CONFIG_PACKAGE_luci-theme-argon=y
          CONFIG_PACKAGE_luci-app-argon-config=y
          
          # ======== MTK ç¡¬ä»¶åŠ é€Ÿ ========
          CONFIG_PACKAGE_luci-app-turboacc-mtk=y
          
          # ======== é£æ‰‡æ§åˆ¶ ========
          CONFIG_PACKAGE_luci-app-Airpifanctrl=y
          
          # ======== å–æ¶ˆé»˜è®¤å‹¾é€‰çš„åŒ… ========
          # CONFIG_PACKAGE_luci-app-wrtbwmon is not set
          # CONFIG_PACKAGE_luci-app-rclone is not set
          # CONFIG_PACKAGE_rclone is not set
          # CONFIG_PACKAGE_rclone-ng is not set
          # CONFIG_PACKAGE_rclone-webui-react is not set
          
          # ======== Modem WebUI ======== (å·²ç¦ç”¨)
          # CONFIG_PACKAGE_modem-webui is not set
          
          # ======== ç¼–è¯‘ä¼˜åŒ– ========
          CONFIG_CCACHE=y
          CONFIG_DEVEL=y
          CONFIG_BUILD_LOG=y
          CONFIG_KERNEL_BUILD_USER="builder"
          CONFIG_KERNEL_BUILD_DOMAIN="github.actions"
          EOF
          
          # ç¡®ä¿å–æ¶ˆå‹¾é€‰çš„åŒ…è¢«æ­£ç¡®å¤„ç†
          sed -i '/CONFIG_PACKAGE_luci-app-wrtbwmon=y/d' .config
          sed -i '/CONFIG_PACKAGE_luci-app-rclone=y/d' .config
          sed -i '/CONFIG_PACKAGE_rclone=y/d' .config
          
          make defconfig

      - name: Verify build config
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¦ å…³é”®åŒ…é…ç½®çŠ¶æ€:"
          grep -E "CONFIG_PACKAGE_(qmodem|luci-app-qmodem|adguardhome|mihomo)=" .config || true

      - name: Download & Compile
        run: |
          cd $SOURCE_DIR
          THREADS=$(($(nproc) + 1))
          export PATH="/usr/lib/ccache:$PATH"
          
          # é¢„çƒ­ ccacheï¼ˆå¦‚æœä¹‹å‰æœ‰ç¼“å­˜ï¼‰
          echo "ğŸ“Š ccache ç¼“å­˜çŠ¶æ€:"
          ccache -s | head -20 || true
          
          # ä¸‹è½½ï¼ˆå¸¦é‡è¯•ï¼Œå¢åŠ å¹¶å‘ï¼‰
          for i in 1 2 3; do make download -j16 && break; find dl -size -1024c -delete 2>/dev/null; sleep 3; done
          
          # ======== å¢é‡ç¼–è¯‘ä¼˜åŒ– ========
          # å¦‚æœ toolchain å·²ç¼“å­˜ï¼Œå°è¯•è·³è¿‡ toolchain ç¼–è¯‘
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1)
          if [ -n "$TOOLCHAIN_DIR" ] && [ -d "$TOOLCHAIN_DIR" ]; then
            echo "âœ… Toolchain ç¼“å­˜å‘½ä¸­: $TOOLCHAIN_DIR"
            # å®‰å…¨åœ° touch stamp æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            find "$TOOLCHAIN_DIR/stamp" -name ".toolchain_*" -exec touch {} \; 2>/dev/null || true
          else
            echo "â„¹ï¸ Toolchain ç¼“å­˜æœªå‘½ä¸­ï¼Œå°†å®Œæ•´ç¼–è¯‘"
          fi
          
          # ç¼–è¯‘ï¼ˆä½¿ç”¨æ›´å¤šçº¿ç¨‹ï¼‰
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS} çº¿ç¨‹)..."
          make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || make -j1 V=s
          
          # ccache æœ€ç»ˆç»Ÿè®¡
          echo "ğŸ“Š ccache æœ€ç»ˆç»Ÿè®¡:"
          ccache -s | grep -E "(hit rate|Hits|Misses|Cached)" || true

      - name: Save build cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
            ${{ env.SOURCE_DIR }}/build_dir/host
            ${{ env.SOURCE_DIR }}/build_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ hashFiles('**/feeds.conf.default') }}-${{ github.run_id }}

      - name: Prepare & Upload artifacts
        run: |
          mkdir -p artifacts
          find $SOURCE_DIR/bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} artifacts/ \;
          ls -lh artifacts/

      - name: Upload to Actions
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-MT7987-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt MT7987/MT7992 #${{ github.run_number }}
          body: |
            ğŸ”§ è‡ªåŠ¨æ„å»º ImmortalWrt MT7987/MT7992 å›ºä»¶
            ğŸ“… æ—¶é—´: ${{ github.event.repository.updated_at }}
            ğŸŒ¿ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
